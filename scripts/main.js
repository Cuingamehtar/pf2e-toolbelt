(()=>{var wr=Object.defineProperty;var r=(e,t)=>wr(e,"name",{value:t,configurable:!0});function it(e){let t=r(o=>o.active&&!o.isGM,"isValidUser"),n=game.users.filter(o=>t(o)&&o.character===e);return n.length||(n=game.users.filter(o=>t(o)&&doc.testUserPermission(o,"OWNER"))),n.sort((o,a)=>o.id>a.id?1:-1),n[0]||null}r(it,"getOwner");function ct(e){return it(e)===game.user}r(ct,"isOwner");function me(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}r(me,"refreshCharacterSheets");function*ge(e,t){let n=ui.chat?.element;if(!n)return;let o=game.messages.contents,a=(t?o.findLastIndex(s=>s===t):o.length)-1;for(let s=a;s>=a-e;s--){let i=o[s];if(!i)return;let c=n.find(`[data-message-id=${i.id}]`);c.length&&(yield{message:i,html:c})}}r(ge,"latestChatMessages");function Q(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}r(Q,"chatUUID");function Nt(e){return!!(e.getFlag("pf2e","casting.embeddedSpell")||e.item?.trickMagicEntry)}r(Nt,"hasEmbeddedSpell");function B(e,...t){return getProperty(e,`modules.${k.id}.${t.join(".")}`)}r(B,"getInMemory");function G(e,...t){let n=t.splice(-1)[0];return setProperty(e,`modules.${k.id}.${t.join(".")}`,n)}r(G,"setInMemory");function Te(e,...t){let n=["modules",k.id,...t],o=n.pop(),a=e;for(let s of n)if(a=a[s],!a)return!0;return delete a[o]}r(Te,"deleteInMemory");function qt(e,t,n){let o={};for(let a of e){let s=Array.isArray(a)?a[n??0]:typeof a=="object"&&n!=null?a[n]:a;o[s]=t(a)}return o}r(qt,"arrayToObject");function lt(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let o of e){let a=n.findIndex(s=>o===s);if(a===-1)return!1;n.splice(a,1)}return!0}r(lt,"compareArrays");function De(e){return e!==void 0&&e!==-1}r(De,"indexIsValid");function xe(e){return Array.from(e.parentElement.children).indexOf(e)}r(xe,"getElementIndex");function jt(e,t,n,o){let a=n-e,s=o-t;return Math.sqrt(a*a+s*s)}r(jt,"calculateDistanceBetweenPoints");function Ae(e,t){if(typeof e!="object")return!1;let n=Reflect.getPrototypeOf(e);for(;n;){if(n.constructor.name===t)return!0;n=Reflect.getPrototypeOf(n)}return!1}r(Ae,"isInstanceOf");function ce(e,...t){return(Array.isArray(t[0])?t[0]:t).filter(o=>typeof o=="string").join(e)}r(ce,"joinStr");function te(...e){return`flags.${k.id}.${ce(".",e)}`}r(te,"flagPath");function E(e,...t){return e.getFlag(k.id,t.join("."))}r(E,"getFlag");function ut(e,...t){return getProperty(e,te(...t))}r(ut,"getFlagProperty");function z(e,...t){let n=t.splice(-1)[0];return e.setFlag(k.id,t.join("."),n)}r(z,"setFlag");function Bt(e,...t){return e.unsetFlag(k.id,t.join("."))}r(Bt,"unsetFlag");function he(e,...t){let n=t.splice(-1)[0];return e.updateSource({[te(...t)]:n})}r(he,"updateSourceFlag");function ye(e,...t){let n=t.splice(-1)[0];e[te(...t)]=n}r(ye,"moduleFlagUpdate");function R(...e){let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:{},n=V(...e);return renderTemplate(n,t)}r(R,"render");function V(...e){return`modules/${k.id}/templates/${ce("/",e)}.hbs`}r(V,"templatePath");function Gt(e,t){let n=Hooks.on(e,t),o=Hooks.events[e].findIndex(a=>a.id===n);if(o!==0){let[a]=Hooks.events[e].splice(o,1);Hooks.events[e].unshift(a)}return n}r(Gt,"registerUpstreamHook");function zt(e){return e.getFlag("core","sourceId")}r(zt,"getSourceId");function Sr(e,t){let n=zt(e);return n?t.includes(n):!1}r(Sr,"includesSourceId");function Wt(e){return Array.isArray(e)?t=>Sr(t,e):t=>zt(t)===e}r(Wt,"getItemSourceIdCondition");function Vt(e,t=[]){let n=typeof t=="string"?[t]:t;return n.length?n.flatMap(o=>e.itemTypes[o]):e.items}r(Vt,"getItems");function Kt(e,t,n){return Vt(e,n).some(Wt(t))}r(Kt,"hasItemWithSourceId");function Oe(e,t,n){return Vt(e,n).find(Wt(t))}r(Oe,"getItemWithSourceId");function F(e,t,n="WRAPPER"){return libWrapper.register(k.id,e,t,n)}r(F,"registerWrapper");function Yt(e){libWrapper.unregister(k.id,e)}r(Yt,"unregisterWrapper");function x(...e){e.unshift(k.id);let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:void 0;return game.i18n[t?"format":"localize"](ce(".",e),t)}r(x,"localize");function Ir(...e){return game.i18n.has(`${k.id}.${e.join(".")}`,!1)}r(Ir,"hasLocalization");function be(...e){return`${k.id}.${e.join(".")}`}r(be,"localizePath");function D(e){let t=r((...n)=>x(e,...n),"fn");return Object.defineProperties(t,{warn:{value:(n,o,a)=>M(`${e}.${n}`,o,a),enumerable:!1,configurable:!1},info:{value:(n,o,a)=>le(`${e}.${n}`,o,a),enumerable:!1,configurable:!1},error:{value:(n,o,a)=>K(`${e}.${n}`,o,a),enumerable:!1,configurable:!1},has:{value:n=>Ir(e,n),enumerable:!1,configurable:!1},path:{value:n=>be(e,n),enumerable:!1,configurable:!1},template:{value:(n,{hash:o})=>t(n,o),enumerable:!1,configurable:!1},i18n:{get(){return{i18n:this.template,i18Path:this.path}},enumerable:!1,configurable:!1}}),t}r(D,"subLocalize");function Pe(e,t){return e.localeCompare(t,game.i18n.lang)}r(Pe,"localeCompare");function ft(e,t,n,o){let a=typeof t=="string"?t:"info",s=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:o??!1;ui.notifications.notify(x(e,s),a,{permanent:i})}r(ft,"notify");function M(e,t,n){ft(e,"warning",t,n)}r(M,"warn");function le(e,t,n){ft(e,"info",t,n)}r(le,"info");function K(e,t,n){ft(e,"error",t,n)}r(K,"error");function Jt(e){e.key??=e.name,Array.isArray(e.choices)&&(e.choices=qt(e.choices,t=>dt(e.key,`choices.${t}`))),e.name??=dt(e.key,"name"),e.hint??=dt(e.key,"hint"),e.scope??="world",e.config??=!0,game.settings.register(k.id,e.key,e)}r(Jt,"registerSetting");function dt(e,t){return`${k.id}.settings.${e}.${t}`}r(dt,"settingPath");function I(e){return game.settings.get(k.id,e)}r(I,"getSetting");function Qt(e,t){return game.settings.set(k.id,e,t)}r(Qt,"setSetting");function Xt(e){game.socket.on(`module.${k.id}`,e)}r(Xt,"socketOn");function Zt(e){game.socket.emit(`module.${k.id}`,e)}r(Zt,"socketEmit");function Er(){return game.user??game.data.users.find(e=>e._id===game.data.userId)}r(Er,"getUser");function en(){let e=Er();return e&&e.role>=CONST.USER_ROLES.ASSISTANT}r(en,"isUserGM");function Re(){return game.user===game.users.activeGM}r(Re,"isActiveGM");function tn(){return game.users.some(e=>e.active&&e.isGM)}r(tn,"isGMOnline");var pt=null,k={get id(){if(!pt)throw new Error("Module id needs to be registered.");return pt},error(e){throw new Error(`[${this.id}] ${e}`)}};function nn(e){pt=e}r(nn,"registerModule");function on(e){return game.modules.get(e??k.id)}r(on,"getModule");var Cr=r((e,t)=>e.modifier>=t.modifier,"HIGHER_BONUS"),kr=r((e,t)=>e.modifier<=t.modifier,"LOWER_PENALTY");function an(e){let t=0,n={},o={},a=e.filter(i=>i.type==="ability"&&!i.ignored),s=a.reduce((i,c)=>i===null||c.force?c:i.force?i:c.modifier>i.modifier?c:i,null);for(let i of a)i.ignored=i!==s;for(let i of e){if(i.ignored){i.enabled=!1;continue}if(i.type==="untyped"){i.enabled=!0,t+=i.modifier;continue}i.modifier<0?t+=rn(o,i,kr):t+=rn(n,i,Cr)}return t}r(an,"applyStackingRules");function rn(e,t,n){let o=e[t.type];return o===void 0?(t.enabled=!0,e[t.type]=t,t.modifier):n(t,o)?(o.enabled=!1,t.enabled=!0,e[t.type]=t,t.modifier-o.modifier):(t.enabled=!1,0)}r(rn,"applyStacking");function sn(e){return Promise.all(e.currentIndex.flatMap(async({uuid:t})=>(await fromUuid(t))?.toObject()))}r(sn,"getTabResults");function Me(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}r(Me,"htmlQuery");function ln(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}r(ln,"ordinalString");function ue(e){return Error(`PF2e System | ${e}`)}r(ue,"ErrorPF2e");var cn;function un(e,{emptyStringZero:t=!1,zeroIsNegative:n=!1}={}){if(e===0&&t)return"";cn??=new Intl.NumberFormat(game.i18n.lang,{maximumFractionDigits:0,signDisplay:"always"});let o=n&&e===0?-0:e;return cn.format(o)}r(un,"signedInteger");async function fn({affects:e,origin:t,target:n,item:o,domains:a,options:s}){if(!(t&&n))return[];let[i,c]=e==="target"?[t,n]:[n,t],l=[...s,i.getRollOptions(a),c.getSelfRollOptions(e)].flat(),u=o?o.isOfType("spell")?{spell:o}:{weapon:o}:{};return(await Promise.all(a.flatMap(f=>i.synthetics.ephemeralEffects[f]?.[e]??[]).map(f=>f({test:l,resolvables:u})))).flatMap(f=>f??[])}r(fn,"extractEphemeralEffects");function dn(e,t){return t.flatMap(n=>(e[n]??[]).map(o=>o.clone()))}r(dn,"extractNotes");function pn(e,t,n){return t.flatMap(o=>e[o]??[]).flatMap(o=>o(n)??[])}r(pn,"extractDamageDice");function mn(e,t,n){let{modifierAdjustments:o,modifiers:a}=e,s=Array.from(new Set(t)).flatMap(i=>a[i]??[]).flatMap(i=>i(n)??[]);for(let i of s)i.adjustments=Tr(o,t,i.slug);return s}r(mn,"extractModifiers");function Tr(e,t,n){return Array.from(new Set(t.flatMap(a=>e[a]??[]))).filter(a=>[n,null].includes(a.slug))}r(Tr,"extractModifierAdjustments");async function mt({message:e,multiplier:t=1,addend:n=0,promptModifier:o=!1,rollIndex:a=0,tokens:s,onDamageApplied:i}){if(o)return Dr({message:e,multiplier:t,rollIndex:a,tokens:s,onDamageApplied:i});if(s??=Me(ui.chat.element[0],`li.chat-message[data-message-id="${e.id}"]`)?.dataset.actorIsTarget&&e.token?[e.token]:game.user.getActiveTokens(),s.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}let c=CONFIG.PF2E.chatDamageButtonShieldToggle,l=e.rolls.at(a);if(!Ae(l,"DamageRoll"))throw ue("Unexpected error retrieving damage roll");let u=t<0?t*l.total+n:l.alter(t,n),f=[...e.flags.pf2e.context?.options??[]],d=f.filter(p=>p.startsWith("self:")).map(p=>p.replace(/^self/,"origin")),g=e.item,h=g?.isOfType("affliction","condition","effect")?g.getRollOptions("item"):[];for(let p of s){if(!p.actor)continue;f.some(H=>H.startsWith("target"))||f.push(...p.actor.getSelfRollOptions("target"));let m=t>0?"damage-received":"healing-received",y=t>0?await fn({affects:"target",origin:e.actor,target:p.actor,item:e.item,domains:[m],options:f}):[],b=p.actor.getContextualClone(d,y),v=new Set([...f.filter(H=>!/^(?:self|target):/.test(H)),...h,...d,...b.getSelfRollOptions()]),S=e.flags.pf2e.context?.outcome,T=[],O=[];if(typeof u=="number"&&u<0){let H=S==="criticalSuccess",P=g?.isOfType("spell")?{spell:g}:g?.isOfType("weapon")?{weapon:g}:{},j=pn(b.synthetics.damageDice,[m],{resolvables:P,test:v}).filter(C=>(C.critical===null||C.critical===H)&&C.predicate.test(v));for(let C of j){let ie=`${C.diceNumber}${C.dieSize}[${C.label}]`,J=await new Roll(ie).evaluate({async:!0});J._formula=`${C.diceNumber}${C.dieSize}`,await J.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:C.label,speaker:ChatMessage.getSpeaker({token:p})}),T.push(`${C.label} ${C.diceNumber}${C.dieSize}`),O.push(J)}O.length&&(u-=O.map(C=>C.total).reduce((C,ie)=>C+ie));let L=mn(b.synthetics,[m],{resolvables:P}).filter(C=>(C.critical===null||C.critical===H)&&C.predicate.test(v));u-=an(L??[]),T.push(...L.filter(C=>C.enabled).map(C=>`${C.label} ${un(C.modifier)}`))}let q=(typeof u=="number"?u!==0:u.total!==0)?dn(b.synthetics.rollNotes,[m]).filter(H=>(!S||H.outcome.length===0||H.outcome.includes(S))&&H.predicate.test(v)):[];await b.applyDamage({damage:u,token:p,item:e.item,skipIWR:t<=0,rollOptions:v,shieldBlockRequest:c,breakdown:T,notes:q})}Le(e.id),i?.(e,s,a)}r(mt,"applyDamageFromMessage");function gn(e,t,n){let o=r(()=>[e],"getTokens"),a=r(s=>s[0]?.actor?.itemTypes.shield.filter(c=>c.isEquipped&&!c.isBroken&&!c.isDestroyed)??[],"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:Me(n,"div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let s=o();if(!s.length)return!1;let i=a(s),c=s.length===1&&i.length>1,l=t.classList.contains("shield-activated");return c&&!l?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(console.log("end of before",t),t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(s,i,c)=>{let l=o(),u=a(l),f=l.length===1&&u.length>1,d=t.classList.contains("shield-activated");if(f&&!d){let g=Me(c,"ul.shield-options");if(!g)return $(c);let h=u.map(p=>{let m=document.createElement("input");m.classList.add("data"),m.type="radio",m.name="shield-id",m.value=p.id,m.addEventListener("click",()=>{t.dataset.shieldId=m.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,s.close()});let y=document.createElement("span");y.classList.add("label"),y.innerHTML=p.name;let b=document.createElement("span");b.classList.add("tag");let v=game.i18n.localize("PF2E.HardnessLabel");b.innerHTML=`${v}: ${p.hardness}`;let S=document.createElement("li");return S.classList.add("item"),S.append(m,y,b),S});g.replaceChildren(...h)}return $(c)}}).tooltipster("open")}r(gn,"onClickShieldBlock");function Le(e){console.trace("toggleOffShieldBlock");for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action$=shield-block]`;for(let o of document.body.querySelectorAll(n))o?.classList.remove("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}r(Le,"toggleOffShieldBlock");async function Dr({message:e,multiplier:t,rollIndex:n,tokens:o,onDamageApplied:a}){let s=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),i=class extends Dialog{static{r(this,"AdjustmentDialog")}activateListeners(l){super.activateListeners(l),l[0].querySelector("input")?.focus()}},c=t<0;new i({title:game.i18n.localize(c?"PF2E.UI.shiftModifyHealingTitle":"PF2E.UI.shiftModifyDamageTitle"),content:s,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async l=>{let u=(Number(l[0].querySelector("input")?.value)||0)*Math.sign(t);mt({message:e,multiplier:t,addend:u,promptModifier:!1,rollIndex:n,tokens:o,onDamageApplied:a})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{Le(e.id)}}).render(!0)}r(Dr,"shiftAdjustDamage");function hn(){return CONFIG.Dice.rolls.find(e=>e.name==="DamageRoll")}r(hn,"getDamageRollClass");var Fe="handwraps-of-mighty-blows";function gt(e){return e.traits.has("invested")}r(gt,"canBeInvested");function yn(e){return e.system.equipped.inSlot!=null}r(yn,"hasWornSlot");function xr(e){return e.system.usage.type==="worn"&&e.system.equipped.inSlot}r(xr,"isWornAs");function ht(e){return e.isInvested||xr(e)}r(ht,"isInvestedOrWornAs");function $e(e){return e.system.usage.type==="held"}r($e,"isHeld");function He(e){return $e(e)&&e.system.usage.value==="held-in-two-hands"}r(He,"isTwoHanded");function bn(e){return $e(e)&&e.system.usage.value==="held-in-one-hand"}r(bn,"isOneHanded");function Ar(e,t){let n=e.system.usage;return n.type==="worn"&&n.where?t:void 0}r(Ar,"inSlotValue");function Or(e,t){let n=t??!e.system.equipped.invested;return e.traits.has("invested")?n:void 0}r(Or,"toggleInvestedValue");function Ue(e,{carryType:t="worn",handsHeld:n=0,inSlot:o,invested:a,containerId:s}){let i={_id:e.id,system:{equipped:{carryType:t,handsHeld:n,inSlot:Ar(e,o),invested:Or(e,a)}}};return s!==void 0&&(i.system.containerId=s),i}r(Ue,"itemCarryUpdate");function _e(e){return e.isOfType("weapon")&&e.slug===Fe&&e.category==="unarmed"}r(_e,"isHandwrapsOfMightyBlows");function vn(e){if(e==="cantrips")return 0;let t=Number(e??NaN);return t.between(0,10)?t:null}r(vn,"spellSlotGroupIdToNumber");var Ne={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},wn=["criticalFailure","failure","success","criticalSuccess"],qe=class e{static{r(this,"DegreeOfSuccess")}constructor(t,n,o=null){t instanceof Roll?(this.dieResult=(t.isDeterministic?t.terms.find(a=>a instanceof NumericTerm):t.dice.find(a=>a instanceof Die&&a.faces===20))?.total??1,this.rollTotal=t.total):(this.dieResult=t.dieValue,this.rollTotal=t.dieValue+t.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=this.#o(),this.adjustment=this.#e(this.unadjusted,o),this.value=this.adjustment?this.#t(this.adjustment.amount,this.unadjusted):this.unadjusted}static CRITICAL_FAILURE=0;static FAILURE=1;static SUCCESS=2;static CRITICAL_SUCCESS=3;#e(t,n){if(!n)return null;for(let o of["all",...wn]){let{label:a,amount:s}=n[o]??{};if(s&&a&&!(t===e.CRITICAL_SUCCESS&&s===Ne.INCREASE)&&!(t===e.CRITICAL_FAILURE&&s===Ne.LOWER)&&(o==="all"||wn.indexOf(o)===t))return{label:a,amount:s}}return null}#t(t,n){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+t,0,3)}}#n(t){return this.dieResult===20?this.#t(Ne.INCREASE,t):this.dieResult===1?this.#t(Ne.LOWER,t):t}#o(){let t=this.dc.value;return this.rollTotal-t>=10?this.#n(e.CRITICAL_SUCCESS):t-this.rollTotal>=10?this.#n(e.CRITICAL_FAILURE):this.rollTotal>=t?this.#n(e.SUCCESS):this.#n(e.FAILURE)}};function Sn(e,{collisionOrigin:t,collisionType:n="move"}={}){let o=e instanceof MeasuredTemplateDocument?e.object:e;if(!canvas.scene)return[];let{grid:a,dimensions:s}=canvas;if(!(a&&s))return[];if(!o?.highlightId)return[];let i=a.getHighlightLayer(o.highlightId);if(!i||a.type!==CONST.GRID_TYPES.SQUARE)return[];let c=t??o.center,l=canvas.tokens.quadtree.getObjects(i.getLocalBounds(void 0,!0)),u=a.size,f=[];for(let d of l){let g=d.document,h=[];for(let p=0;p<g.height;p++){let m=Math.floor(d.x/u)*u,b=Math.floor(d.y/u)*u+p*u;if(h.push(`${m}.${b}`),g.width>1)for(let v=1;v<g.width;v++)h.push(`${m+v*u}.${b}`)}for(let p of h){if(!i.positions.has(p))continue;let[m,y]=p.split(".").map(S=>Number(S)),b={x:m+s.size*.5,y:y+s.size*.5};if(b.x<0||b.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,b,{type:n,mode:"any"}))){f.push(d);break}}}return f}r(Sn,"getTemplateTokens");function Y(e,t){console.error(`an error occured in the feature '${e}' of the module '${k.id}' with the wrapper: '${t}'`)}r(Y,"wrapperError");async function yt(e,{user:t=game.user,synchronize:n=!0}={}){if(game.modules.get("dice-so-nice")?.active)return game.dice3d.showForRoll(e,t,n)}r(yt,"roll3dDice");var In="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",En="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Cn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",kn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData";function Tn(){return{settings:[{key:"auto-runes",type:String,default:"disabled",choices:["disabled","force","lower"],requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{let e=I("auto-runes");e!=="disabled"&&(F(In,Lr,"WRAPPER"),F(En,Fr,"WRAPPER"),F(Cn,Ur,"WRAPPER"),F(kn,_r,"WRAPPER"),e==="force"&&Hooks.on("renderPhysicalItemSheetPF2e",Nr))},ready:e=>{e&&I("auto-runes")!=="disabled"&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),le("arp.forceVariant"))}}}r(Tn,"registerArp");function ve(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}r(ve,"isValidActor");var Pr={1:35,2:935,3:8935,4:8935},Rr={1:65,2:1065,3:31065};function Mr(e){return["shield-boss","shield-spikes"].includes(e._source.system.baseItem)}r(Mr,"isShieldWeapon");function Dn(e){let t=e._source.system.traits.value,{group:n,category:o,slug:a}=e._source.system;return o==="unarmed"&&a!==Fe?!!e.actor.itemTypes.weapon.find(s=>s.slug===Fe&&s.category==="unarmed"&&s.isEquipped&&s.isInvested):(n!=="shield"||Mr(e))&&!t.includes("alchemical")&&!t.includes("bomb")}r(Dn,"isValidWeapon");function Lr(e){try{let t=this.actor;if(!ve(t,!0)||!Dn(this))return e();let n=this._source.system.traits.value;if(n.includes("alchemical")&&n.includes("bomb"))return e();let o=t.level,a=I("auto-runes")==="force",s=o<2?null:o<10?1:o<16?2:3,i=o<4?null:o<12?1:o<19?2:3;(this.system.runes.potency<=s||a)&&(this.system.runes.potency=s),(this.system.runes.striking<=i||a)&&(this.system.runes.striking=i)}catch{Y("auto-runes",In)}e()}r(Lr,"onPrepareWeaponData");function Fr(e){e();try{if(!ve(this.actor)||this.isSpecific||!Dn(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=Pr[n]);let o=this.system.runes.striking;o&&(t.gp-=Rr[o]),t=new game.pf2e.Coins(t),(n||o)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{Y("auto-runes",En)}}r(Fr,"onPrepareWeaponDerivedData");var $r={1:160,2:1060,3:20560,4:20560},Hr={1:340,2:3440,3:49440};function xn(e){return!0}r(xn,"isValidArmor");function Ur(e){try{let t=this.actor;if(!ve(t,!0)||!xn(this))return e();let n=t.level,o=I("auto-runes")==="force",a=n<5?null:n<11?1:n<18?2:3,s=n<8?null:n<14?1:n<20?2:3;(this.system.runes.potency<=a||o)&&(this.system.runes.potency=a),(this.system.runes.resilient<=s||o)&&(this.system.runes.resilient=s)}catch{Y("auto-runes",Cn)}e()}r(Ur,"onPrepareArmorData");function _r(e){e();try{if(!ve(this.actor)||this.isSpecific||!xn(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=$r[n]);let o=this.system.runes.resilient;o&&(t.gp-=Hr[o]),t=new game.pf2e.Coins(t),(n||o)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{Y("auto-runes",kn)}}r(_r,"onPrepareArmorDerivedData");function Nr(e,t){let n=e.item;if(!n||!n.isOfType("weapon","armor")||!ve(n.actor,!0))return;let o=["potency","striking","resilient"].map(a=>`[name="system.runes.${a}"]`).join(", ");t.find(`[data-tab=details] fieldset .form-group:has(${o})`).hide()}r(Nr,"renderPhysicalItemSheetPF2e");function A(e,t,n=()=>{}){let o=null;return(a,s=[],i=!1)=>{let l=a||(typeof s=="string"?[s]:s).some(u=>I(u));l&&!o?o=Hooks.on(e,t):!l&&o&&(Hooks.off(e,o),o=null),i||n(l)}}r(A,"createHook");function An(e,t,n=()=>{}){let o=null;return(a,s=!1)=>{a==="disabled"&&o?(Hooks.off(e,o),o=null):a!=="disabled"&&!o&&(o=Hooks.on(e,t)),s||n(a)}}r(An,"createChoicesHook");var qr=A("renderApplication",bt),jr=A("renderActorSheet",bt),Br=A("renderItemSheet",bt);function Pn(){return{settings:[{key:"debug",type:Boolean,default:!1,config:!1,scope:"client",onChange:e=>On(e)}],init:()=>{On()}}}r(Pn,"registerDebug");function On(e){let t=e??I("debug");qr(t),jr(t),Br(t)}r(On,"setup");function bt(e,t){let n=t.find(".document-id-link")[0];n&&n.addEventListener("click",o=>{if(!o.shiftKey)return;let a=e.object;if(!a)return;o.preventDefault(),o.stopPropagation();let s=a.type,i=2,c=s;for(;window[c];)c=`${s}${i++}`;window[c]=a,console.log(c,a)},!0)}r(bt,"onRender");var vt=A("renderEffectsPanel",zr,Gr);function Rn(){return{settings:[{key:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>vt(e,"condition-sheet")},{key:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>vt(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{vt(!1,["effect-remove","condition-sheet"])}}}r(Rn,"registerEffectsPanelHelper");function Gr(){game.pf2e.effectPanel?.render()}r(Gr,"refreshEffectsPanel");function zr(e,t){let n=`<div>${x("effects.remove")}</div>`,o='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',a=t.find(".effect-item[data-item-id]").toArray();for(let s of a){let i=s.dataset.itemId,c=e.actor?.items.get(i);if(c&&(I("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(s.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),s.querySelector(".icon").addEventListener("contextmenu",l=>Vr(l,e),!0)),I("condition-sheet")&&c.isOfType("condition"))){let l=s.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",o),l.querySelector('[data-action="edit"]').addEventListener("click",u=>Wr(u,e))}}}r(zr,"renderEffectsPanel");function Wr(e,t){let n=Mn(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}r(Wr,"onConditionSheet");function Vr(e,t){if(!e.shiftKey)return;let n=Mn(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}r(Vr,"onRemoveEffect");function Mn(e,t){let a=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(a)}r(Mn,"getEffect");var U={wrapperIds:[],tabs:new Collection},je={wrapperIds:[],listeners:new Map},Ln="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",Kr="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner",Yr="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render",Jr="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners";function _(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}r(_,"isPlayedActor");function Fn(e,t){je.wrapperIds.length||(je.wrapperIds=[F(Ln,Qr,"WRAPPER")]),je.listeners.set(e,t)}r(Fn,"registerActorPreparedEmbeddedDocuments");function Be(e){U.wrapperIds.length||(U.wrapperIds=[F(Yr,Xr),F(Kr,Zr),F(Jr,ea)]),U.tabs.set(e.tabName,e)}r(Be,"registerCharacterSheetExtraTab");function Ge(e){if(U.tabs.delete(e),U.wrapperIds.length&&!U.tabs.size){for(let t of U.wrapperIds)Yt(t);U.wrapperIds=[]}}r(Ge,"unregisterCharacterSheetExtraTab");function Qr(e,...t){e(...t);for(let[n,o]of je.listeners)try{o.call(this)}catch{wrapperError(n,Ln)}}r(Qr,"actorPrepareEmbeddedDocuments");async function Xr(e,...t){let n={};for(let{tabName:o}of U.tabs){let s=X(this.element,o).find(".alternate")[0];s&&(n[o]=s.scrollTop)}await e(...t);for(let{tabName:o}of U.tabs){if(!n[o])continue;let i=X(this.element,o).find(".alternate")[0];i.scrollTop=n[o]}}r(Xr,"characterSheetRender");async function Zr(e,t){let n=await e(t),o=this.actor;if(!U.tabs.size||!_(o))return n;let a=this.element;for(let{tabName:s,getData:i,templateFolder:c,onRender:l}of U.tabs){let u=X(n,s),f=await i(o,this,X(a,s)),d=await R(c,f);l&&await l(o,this,n),B(this,`${s}.toggled`)&&u.addClass("toggled"),u.children(":last").before(d)}return n}r(Zr,"characterSheetInnerRender");function ea(e,t){e(t);let n=this.actor;if(!(!U.tabs.size||!_(n)))for(let{tabName:o,addEvents:a}of U.tabs){t.find(`nav.sheet-navigation .item[data-tab=${o}]`).on("click",i=>ta(i,t,this,o));let s=X(t,o);a(s.find("> .alternate"),this,n,t)}}r(ea,"characterSheetActiveListeners");function X(e,t){return e.find(`section.sheet-body .sheet-content > .tab[data-tab=${t}]`)}r(X,"getCharacterSheetTab");function ta(e,t,n,o){e.preventDefault();let a=X(t,o);a.hasClass("active")&&(a.toggleClass("toggled"),a.scrollTop(0),G(n,`${o}.toggled`,a.hasClass("toggled")))}r(ta,"onCharacterSheetTabBtnToggle");var ze=class extends FormApplication{static{r(this,"MoveLootPopup")}constructor(t,n,o){super(t,n),this.onSubmitCallback=o}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};var ne={};function $n(e,t){if(game.user.id===t)return;let o=ne[e.key];o?.active&&o.listener(e,t)}r($n,"onSocket");function fe(e,t){return ne[e]&&k.error(`a socket listener with the key '${e}' has already been registered`),ne[e]={listener:t,active:!1},{emit:n=>{n.key=e,Zt(n)},activate:()=>{ne[e].active=!0},disable:()=>{ne[e].active=!1},toggle:n=>{ne[e].active=n??!ne[e].active}}}r(fe,"registerSocket");var We=!1,we=null,Se=fe("giveth",na);function _n(){return{settings:[{key:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:Hn}],conflicts:["pf2e-giveth"],ready:e=>{I("giveth")!=="disabled"&&Hn(!0)}}}r(_n,"registerGiveth");function Hn(e){let t=game.user.isGM;e==="disabled"&&We?(t?Se.disable():we&&(Hooks.off("dropCanvasData",we),we=null),We=!1):e!=="disabled"&&!We&&(t?Se.activate():we||(we=Gt("dropCanvasData",oa)),We=!0)}r(Hn,"setup");function na(e){e.type==="giveth-condition"?sa(e):e.type==="giveth-effect"?ia(e):ca(e)}r(na,"onSocket");function oa(e,t){if(!tn())return!0;let n=aa(t);if(!n)return!0;let o=e.tokens.placeables.slice().filter(a=>{if(!a.document.actorLink)return!1;let s=a.actor;if(!Nn(s,t.actorId)||s.isOwner)return!1;let i=a.x+(a.hitArea?.right??0),c=a.y+(a.hitArea?.bottom??0);return t.x>=a.x&&t.y>=a.y&&t.x<=i&&t.y<=c}).sort((a,s)=>s.document.sort-a.document.sort).at(0)?.actor;return o?(ra(n.actor,o,n.item,n.value),!1):!0}r(oa,"onDropCanvasData");function ra(e,t,n,o){let a=e.id,s=t.id,i=!(n instanceof Item);if(!i&&n.isOfType("physical")){let c=n.quantity;if(c<1)return M("giveth.notification.zero");if(c===1)return Un(a,s,n.id,1,!1);new ze(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,u)=>{Un(a,s,n.id,l,u)}).render(!0)}else{let c=i?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?Se.emit({type:"giveth-condition",targetId:s,value:o??1,uuid:c}):Se.emit({type:"giveth-effect",targetId:s,uuid:c})}}r(ra,"giveth");function Un(e,t,n,o,a){Se.emit({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:o,stack:a})}r(Un,"sendPhysicalRequest");function Nn(e,t){return!_(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}r(Nn,"isValidActor");function aa(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let a=e.context?.origin.actor;n=a?fromUuidSync(a):null}if(!Nn(n)||!n.isOwner)return;let o=!(t instanceof Item);if(o&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!o&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}r(aa,"getDetailsFromData");async function sa({targetId:e,uuid:t,value:n}){let o=game.actors.get(e);if(!o)return;let a=await fromUuid(t);a&&o.increaseCondition(a.slug,{min:n})}r(sa,"takethCondition");async function ia({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let o=await fromUuid(t);if(!o)return;let a=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[a])}r(ia,"takethEffect");async function ca({itemId:e,ownerId:t,qty:n,stack:o,targetId:a}){let s=game.actors.get(t),i=game.actors.get(a);if(!s||!i)return;let c=s.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,u=c.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=c.traits.has("invested")?!1:null);let f=await i.addToInventory(u,void 0,o);if(!f||(l<1?c.delete():c.update({"system.quantity":l}),I("giveth")==="no-message"))return;let d=Q(f.uuid,f.name,!f.isIdentified);n>1&&(d+=` x${n}`);let g=x("giveth.giveth",{target:i.name});ChatMessage.create({flavor:`<h4 class="action">${g}</h4>`,content:d,speaker:ChatMessage.getSpeaker({actor:s})})}r(ca,"takethPhysical");var de=D("hero.templates.trade"),Ve=class extends Application{static{r(this,"Trade")}constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(Application.defaultOptions,{title:de("title"),template:V("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){de.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:W(this.actor),targetActions:this.target?W(this.target):[],i18n:de.template})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){de.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){de.warn("no-select");return}let o=it(this.target)??game.users.activeGM;if(!o){de.warn("no-user");return}qn({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:o.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};var Ke="pf2e-hero-actions",Ie=fe("hero-action",da),jn=A("renderCharacterSheetPF2e",pa,fa),la="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",Ye="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",ua="systems/pf2e/icons/features/feats/heroic-recovery.webp";function Bn(){return{name:"heroActions",settings:[{key:"hero",type:Boolean,default:!1,onChange:e=>jn(e)},{key:"hero-table",type:String,default:""},{key:"hero-trade",type:Boolean,default:!1,onChange:()=>me()},{key:"hero-private",type:Boolean,default:!1}],conflicts:[Ke],api:{createTable:Ta,removeHeroActions:Pa,getHeroActions:W,useHeroAction:Kn,getHeroActionDetails:Je,drawHeroAction:Vn,drawHeroActions:zn,sendActionToChat:Zn,discardHeroActions:Yn,tradeHeroAction:Wn,getDeckTable:It,giveHeroActions:La,createChatMessage:Qe},ready:()=>{jn(!1,"hero")}}}r(Bn,"registerHeroActions");function fa(e){Ie.toggle(e)}r(fa,"setupSocket");function da(e){switch(e.type){case"hero.trade-reject":if(e.sender.id!==game.user.id)return;oo(e);break;case"hero.trade-accept":if(!Re())return;to(e);break;case"hero.trade-request":if(e.receiver.id!==game.user.id)return;Ca(e);break;case"hero.trade-error":if(!e.users.includes(game.user.id))return;no(e.error);break}}r(da,"onSocket");async function pa(e,t){let n=e.actor;_(n)&&(await ma(t,n),ga(t,n))}r(pa,"renderCharacterSheetPF2e");async function ma(e,t){let n=W(t),o=t.heroPoints.value-n.length,a=t.isOwner,s=D("hero.templates.heroActions"),i=await R("hero/sheet",{owner:a,list:n,canUse:o>=0&&a,canDraw:o>0&&a,canTrade:I("hero-trade"),mustDiscard:o<0,diff:Math.abs(o),i18n:s.template});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(i)}r(ma,"addActionsToSheet");function ga(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",o=>wa(t,o)),n.find("[data-action=expand]").on("click",Gn),n.find("[data-action=use]").on("click",o=>va(t,o)),n.find("[data-action=display]").on("click",o=>ba(t,o)),n.find("[data-action=discard]").on("click",ya),n.find("[data-action=discard-selected]").on("click",()=>ha(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>Wn(t))}r(ga,"addSheetEvents");async function ha(e,t){let o=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(a=>a.dataset.uuid);Yn(e,o)}r(ha,"onClickHeroActionsDiscard");function ya(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let o=Number(n.attr("data-discard")??"0"),a=n.find(".action.discarded");n.toggleClass("discardable",a.length===o)}r(ya,"onClickHeroActionDiscard");async function ba(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Zn(e,n)}r(ba,"onClickHeroActionDisplay");async function va(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Kn(e,n)}r(va,"onClickHeroActionUse");async function wa(e,t){t.preventDefault(),zn(e)}r(wa,"onClickHeroActionsDraw");function W(e){return getProperty(e,`flags.${Ke}.heroActions`)??[]}r(W,"getHeroActions");async function oe(e,t){return e.update({[`flags.${Ke}.heroActions`]:t})}r(oe,"setHeroActions");async function Gn(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let o=t.attr("data-uuid"),a=await Je(o);if(!a)return;let s=await TextEditor.enrichHTML(a.description,{async:!0});n.find(".item-description").html(s),n.addClass("loaded")}t.toggleClass("expanded")}r(Gn,"onClickHeroActionExpand");async function Je(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,o=t instanceof JournalEntry?t.pages.contents[0]:t,a=o?.text.content;if(a)return n.uuid===la&&(a=a.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:o.name,description:a}}r(Je,"getHeroActionDetails");async function zn(e){if(!e?.isOfType("character")){M("hero.onlyCharacter");return}let t=W(e),n=e.heroPoints.value-t.length,o=[];for(let a=0;a<n;a++){let s=await Vn();if(s!==void 0){if(s===null)return;t.push(s),o.push(s)}}o.length&&(oe(e,t),Qe({actor:e,actions:o,label:a=>x("hero.actions-draw.header",{nb:a}),secret:!0}))}r(zn,"drawHeroActions");function Qe({actor:e,actions:t,label:n,secret:o=!1}){let{content:a,size:s}=Sa(t);n=typeof n=="function"?n(s):n;let i={flavor:`<h4 class="action">${n}</h4>`,content:a,speaker:ChatMessage.getSpeaker({actor:e})};o&&I("hero-private")&&(i.type=CONST.CHAT_MESSAGE_TYPES.ROLL,i.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(i)}r(Qe,"createChatMessage");function Sa(e){let t=e.map(({uuid:n,name:o})=>Q(n,o));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}r(Sa,"chatActions");function Wn(e){if(!e?.isOfType("character")){M("hero.onlyCharacter");return}let t=W(e);if(!t||!t.length){M("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){M("hero.no-points",{nb:n.toString()});return}new Ve(e).render(!0)}r(Wn,"tradeHeroAction");async function Vn(){let e=await It(),t=D("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(s=>!s.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let o=ro(n);if(o)return{uuid:o,name:await Jn(n,o)}}r(Vn,"drawHeroAction");async function Kn(e,t){if(!e?.isOfType("character")){M("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return M("hero.use.noPoints");let o=W(e),a=o.findIndex(i=>i.uuid===t);if(a===-1)return;let s=await Je(t);s||K("hero.use.noDetails"),o.splice(a,1),s?(e.update({"system.resources.heroPoints.value":n-1,[`flags.${Ke}.heroActions`]:o}),ChatMessage.create({flavor:`<h4 class="action">${x("hero.actions-use.header")}</h4>`,content:`<h2>${s.name}</h2>${s.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):oe(e,o)}r(Kn,"useHeroAction");async function Yn(e,t){if(!e?.isOfType("character")){M("hero.onlyCharacter");return}let n=typeof t=="string"?[t]:t,o=W(e),a=[];for(let s of n){let i=o.findIndex(c=>c.uuid===s);i!==-1&&(a.push(o[i]),o.splice(i,1))}oe(e,o),Qe({actor:e,actions:a,label:s=>x("hero.actions-discard.header",{nb:s})})}r(Yn,"discardHeroActions");async function Jn(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}r(Jn,"getLabelfromTableResult");async function Qn(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}r(Qn,"getTableFromUuid");async function Ia(){return Qn(Ye)}r(Ia,"getDefaultCompendiumTable");function Xn(){return game.tables.find(e=>e.getFlag("core","sourceId")===Ye)}r(Xn,"getDefaultWorldTable");async function Ea(){return Qn(I("hero-table"))}r(Ea,"getCustomTable");async function It(){return await Ea()??Xn()??await Ia()}r(It,"getDeckTable");async function Zn(e,t){let n=await Je(t);if(!n)return K("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}r(Zn,"sendActionToChat");function qn(e){if(e.receiver.id===game.user.id){eo(e);return}Ie.emit({...e,type:"hero.trade-request"})}r(qn,"sendTradeRequest");function eo(e){if(game.user.isGM){to(e);return}Ie.emit({...e,type:"hero.trade-accept"})}r(eo,"acceptRequest");async function to(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),a=game.actors.get(n.cid);if(!o||!a){wt(e);return}let s=W(o),i=W(a),c=s.findIndex(m=>m.uuid===t.uuid),l=i.findIndex(m=>m.uuid===n.uuid);if(c===-1||l===-1){wt(e);return}let u=s.splice(c,1)[0],f=i.splice(l,1)[0];s.push(f),i.push(u),oe(o,s),oe(a,i);let d=Q(u.uuid),g=Q(f.uuid),h=D("hero.trade-success"),p=`<div style="line-height: 1.6">${h("offer",{offer:d})}</div>`;p+=`<div style="line-height: 1.6">${h("receive",{receive:g})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${h("header",{name:a.name})}</h4>`,content:p,speaker:ChatMessage.getSpeaker({actor:o})})}r(to,"onTradeAccepted");function wt({sender:e,receiver:t},n="trade-error"){let o=new Set([e.id,t.id]);o.has(game.user.id)&&(o.delete(game.user.id),no(n)),o.size&&Ie.emit({type:"hero.trade-error",users:Array.from(o),error:n})}r(wt,"sendTradeError");function no(e){K("hero.trade-error")}r(no,"onTradeError");async function Ca(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),a=game.actors.get(n.cid);if(!o||!a){wt(e);return}let s=D("hero.trade-request"),i=`<p>${s("header",{sender:o.name,receiver:a.name})}</p>`;i+=`<p>${s("give",{give:Q(t.uuid)})}</p>`,i+=`<p>${s("want",{want:Q(n.uuid)})}</p>`,i+=`<p style="margin-bottom: 1em;">${s("accept")}</p>`,await Dialog.confirm({title:s("title"),content:await TextEditor.enrichHTML(i,{async:!0})})?eo(e):ka(e)}r(Ca,"onTradeRequest");function ka(e){if(e.sender.id===game.user.id){oo(e);return}Ie.emit({...e,type:"hero.trade-reject"})}r(ka,"rejectRequest");async function oo({receiver:e}){let t=game.actors.get(e.cid);M("hero.trade-rejected",{name:t.name},!0)}r(oo,"onTradeRejected");async function Ta(){if(!game.user.isGM){M("hero.notGM");return}let e=D("hero.templates.createTable.choice"),t=V("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:s=>{let i=s.find('.window-content input[name="type"]:checked').val(),c=s.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:i,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{i18n:e.template}),title:e("title"),buttons:n,default:"yes",close:()=>null},a=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-create-table"});a&&(a.type==="default"?Aa(a.unique):Da(a.unique))}r(Ta,"createTable");async function Da(e){let t=await xa(e);await St(t),t.sheet?.render(!0)}r(Da,"createCustomTable");function xa(e=!0){let t=Et(e);return RollTable.create(t,{temporary:!1})}r(xa,"createCustomActionsTable");async function Aa(e){let t=D("templates.createTable.default.confirm"),n=await Xn();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let a=Et(e);return await n.update(a),St(n,!0)}n=await Oa(e),await St(n)}r(Aa,"createDefaultTable");async function Oa(e=!0){let t=await fromUuid(Ye),n=Et(e,t);return RollTable.create(n,{temporary:!1})}r(Oa,"createDefautActionsTable");async function St(e,t=!1){t&&await e.normalize(),await Qt("hero-table",e.uuid)}r(St,"setTable");function Et(e,t){let n={name:x("hero.table.name"),replacement:!(e??!0),img:ua,description:x("hero.table.description"),flags:{core:{sourceId:Ye}}};return t?mergeObject(deepClone(t._source),n):n}r(Et,"getTableSource");async function Pa(){if(!game.user.isGM){M("hero.notGM");return}let e=D("hero.templates.removeActions"),t=V("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:s=>s.find('input[name="actor"]:checked').toArray().map(i=>game.actors.get(i.value)).filter(i=>i)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{actors:game.actors.filter(s=>s.type==="character"),i18n:e.template}),title:e("title"),buttons:n,default:"yes",render:s=>{s.on("change",'input[name="all"]',()=>Ra(s)),s.on("change",'input[name="actor"]',()=>Ma(s))},close:()=>null},a=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-remove-actions"});if(a){if(!a.length){e.warn("noSelection");return}for(let s of a)oe(s,[]);e.info("removed")}}r(Pa,"removeHeroActions");function Ra(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}r(Ra,"removeActionsToggleAll");function Ma(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),o=e.find('input[name="all"]');t.length===n.length?(o.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?o.prop("checked",!1).prop("indeterminate",!0):(o.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}r(Ma,"removeActionsToggleActor");function ro(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}r(ro,"documentUuidFromTableResult");async function La(e){if(!game.user.isGM){M("hero.notGM");return}let t=D("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await It();if(!n)return K("hero.table.drawError",!0),null;let o=n.replacement===!1,a=(await Promise.all(n.results.map(async m=>{let y=ro(m);if(y)return{key:m.id,uuid:y,name:await Jn(m,y),drawn:m.drawn}}))).filter(Boolean),s=V("hero/dialogs/give-action"),i=await renderTemplate(s,{actions:a,isUnique:o,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:m=>({selected:m.find("[name=action]:checked").closest(".action").toArray().map(y=>y.dataset),asDrawn:m.find("[name=drawn]").prop("checked")??!1,withMessage:m.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:i,buttons:c,render:m=>{m.find("[data-action=expand]").on("click",Gn)},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!u)return;let{selected:f,asDrawn:d,withMessage:g}=u,h=W(e),p=[];for(let{uuid:m,name:y,key:b}of f){if(h.push({uuid:m,name:y}),!d)continue;let v=n.results.get(b);v&&!v.drawn&&p.push(b)}p.length&&await n.updateEmbeddedDocuments("TableResult",p.map(m=>({_id:m,drawn:!0}))),oe(e,h),g&&Qe({actor:e,actions:f,label:m=>x("hero.actions-give.header",{nb:m}),secret:!0})}r(La,"giveHeroActions");var w=null,Fa=0;function ao(e,t){for(let[n,o]of Object.entries(t))for(let a of o){let s=e[a];!s||typeof s===n||(e[s]=void 0)}}r(ao,"cleanOptions");function so(e){if(e.element instanceof HTMLElement){ao(e,{string:["draggedClass","group","selector","filter","identifier"],number:["triggerDistance"],boolean:["cancelOnRightClick"],function:["onCancel","onDragEnd","onDragStart"]}),e.triggerDistance??=6,e.cancelOnRightClick??=!0,e.cursorImage??={},e.cursorImage.id=typeof e.cursorImage.id=="string"?e.cursorImage.id:"",e.cursorImage.img=typeof e.cursorImage.img=="function"?e.cursorImage.img:void 0,e.droppables??=[];for(let t=e.droppables.length-1;t>=0;t--){let n=e.droppables[t];if(!(n.element instanceof HTMLElement)){e.droppables.splice(t,1);continue}ao(n,{string:["selector","overClass","filter"],boolean:["purgeOnLeave"],function:["onDragEnter","onDragLeave","onDragOver","onDrop"]})}e.element.addEventListener("mousedown",t=>Ha(t,e))}}r(so,"makeDraggable");async function $a(e){w&&(w.canceled=!0,w.dragging&&w.draggable.ghost&&w.draggable.ghost.reset(),w.dragging&&w.options.onCancel&&await w.options.onCancel(e,w.draggable),co(),await io(e))}r($a,"onDragCancel");async function io(e){w&&(w.dragging&&w.options.onDragEnd&&await w.options.onDragEnd(e,w.draggable,{canceled:w.canceled,dropped:w.dropped}),window.removeEventListener("mousemove",lo),window.removeEventListener("mouseup",uo),w=null)}r(io,"onDragEnd");function co(){if(w){w.draggable.classList.purge(),w.draggable.ghost?.classList.purge(),w.cursorElement?.remove();for(let{classList:e}of Object.values(w.hovered))e.purge()}}r(co,"cleanUp");function Ha(e,t){if(e.button===2&&w?.dragging&&w.options.cancelOnRightClick){$a(e);return}if(e.button)return;let n=Ee(e.target,t.element,t);if(!n)return;let o,a=xe(n),s=n.parentElement,i=Ct(n);w={canceled:!1,dragging:!1,dropped:!1,options:t,group:t.group,draggable:{identifier:t.identifier,element:n,triggeringElement:e.target,x:e.clientX,y:e.clientY,parent:s,index:a,classList:i,get ghost(){if(o)return t.ghostClass&&o.classList.add(t.ghostClass),o;let{element:c=n.cloneNode(!0),index:l=1/0}=t.createGhost?.(n,a)??{},u=Ct(c);return t.draggedClass&&c!==n&&c.classList.remove(t.draggedClass),t.ghostClass&&u.add(t.ghostClass),o={element:c,classList:u,index:l,reset:()=>{if(c.remove(),c===n){let f=s.children[a];s.insertBefore(n,f),o.index=a,t.ghostClass&&u.remove(t.ghostClass)}else o.index=1/0}},o},resetPosition:()=>{n.remove(),s.children[a].before(n)}},droppables:t.droppables.map(c=>({...c,id:Fa++})),hovered:{}},window.addEventListener("mousemove",lo),window.addEventListener("mouseup",uo)}r(Ha,"onMouseDown");async function lo(e){if(!w)return;if(w.dragging){_a(e);return}let{clientX:t,clientY:n}=e,{draggable:o}=w;jt(o.x,o.y,t,n)>w.options.triggerDistance&&await Ua(e)}r(lo,"onMouseMove");async function uo(e){if(!(e.button||!w)){if(w.dragging){let t=!1;co(),await Promise.all(Object.values(w.hovered).map(async n=>{if(!n.droppable.onDrop)return;await n.droppable.onDrop(e,w.draggable,{classList:n.classList,element:n.element,triggeringElement:n.triggeringElement})&&(t=!0)})),w.dropped=t}await io(e)}}r(uo,"onMouseUp");async function Ua(e){if(!w.dragging){if(w.dragging=!0,w.options.cursorImage.img){let t=w.options.cursorImage.img(w.draggable.element);t instanceof HTMLElement?w.cursorElement=t:(w.cursorElement=new Image,w.cursorElement.src=typeof t=="string"?t:"")}else w.cursorElement=w.draggable.element.cloneNode(!0);w.cursorElement.id=w.options.cursorImage.id,w.options.draggedClass&&w.draggable.classList.add(w.options.draggedClass),document.body.appendChild(w.cursorElement),await w.options.onDragStart?.(e,w.draggable)}}r(Ua,"onDragStart");async function _a(e){if(!w)return;let{clientX:t,clientY:n}=e,o=w.cursorElement,a=o.offsetWidth/2,s=o.offsetHeight/2;o.style.left=`${t-a}px`,o.style.top=`${n-s}px`,await Promise.all(w.droppables.map(async i=>{let c=Ee(e.target,i.element,{selector:i.selector,filter:i.filter}),l=w.hovered[i.id];if(l&&(!c||l.element!==c)&&await i.onDragLeave?.(e,w.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target})!==!1&&(delete w.hovered[i.id],i.purgeOnLeave?l.classList.purge():i.overClass&&l.classList.remove(i.overClass)),!!c)if(l)i.onDragOver&&await i.onDragOver(e,w.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target});else{let u=Ct(c);await i.onDragEnter?.(e,w.draggable,{classList:u,element:c,triggeringElement:e.target})!==!1&&(i.overClass&&u.add(i.overClass),w.hovered[i.id]={id:i.id,classList:u,droppable:i,element:c,triggeringElement:e.target})}}))}r(_a,"onDragMove");function Ct(e){return new class extends Set{add(t){e.classList.add(t),super.add(t)}remove(t){e.classList.remove(t),super.delete(t)}toggle(t,n){n??!e.classList.contains(t)?this.add(t):this.remove(t)}contains(t){return this.has(t)}purge(){e.classList.remove(...this)}}}r(Ct,"newClassList");function Ee(e,t,{selector:n,filter:o}={}){if(!t.contains(e))return;if(!n&&!o)return t;let a,s=e;for(;;){if(o&&s.matches(o))return;if(!a&&n&&s.matches(n)&&(a=s),s===t)break;s=s.parentElement}return n?a:t}r(Ee,"closestInside");var Na=A("closeCharacterSheetPF2e",ja),Tt=!1;function po(){return{settings:[{key:"inventory",type:Boolean,default:!1,scope:"client",onChange:e=>fo(e)}],ready:e=>{fo()}}}r(po,"registerInventory");var kt,qa=["platinum-pieces","gold-pieces","silver-pieces","copper-pieces"];function fo(e){let t=e??I("inventory");t?Be({tabName:"inventory",templateFolder:"inventory/sheet",getData:Ga,addEvents:za,onRender:Ba}):Ge("inventory"),Na(t)}r(fo,"setup");function ja(e,t){let n=e.actor;if(!_(n)||!B(e,"inventory.requireSave"))return;let o=X(t,"inventory")[0],a=mo(o);a&&z(n,"inventory",a)}r(ja,"closeCharacterSheetPF2e");function Ba(e,t,n){let o=n.find("> aside");o.css("position","relative"),o.append("<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>")}r(Ba,"onRender");function mo(e){if(!e)return;let t=e.querySelector(":scope > .alternate"),n=t.querySelector("[data-area='equipped']"),o=r(i=>n.querySelector(`[data-equipped-slot='${i}']`).querySelector("[data-item-id]")?.dataset.itemId??null,"equippedItemId"),a=r(i=>{let c={},l=i.querySelectorAll(":scope > [data-item-id]");for(let u=0;u<l.length;u++){let f=l[u];c[f.dataset.itemId]=u}return c},"itemIds"),s={};for(let i of t.querySelectorAll("[data-area='items-grid']")){let c=i.dataset.tabId;s[c]=a(i)}return{equipped:{hands:[o("left-hand"),o("right-hand")],armor:[o("armor")],others:a(n)},tabs:s}}r(mo,"getCurrentData");async function Ga(e,t,n){let o=E(e,"inventory"),a=mo(n[0])??o??{equipped:{hands:[null,null],armor:[null],others:{}},tabs:{}};o||G(t,"inventory.requireSave",!0);let s=new Collection,i={},c=new Set,l={hands:[null,null],armor:[null],others:[]};function u(d){let g=d?.id,h=s.get(g);return h||(h={id:g,item:d,parent:d?.container,containers:[],matrix:[],parents:[]},s.set(g,h),h)}r(u,"getTab");for(let d of e.inventory){if(d.isOfType("treasure")&&d.system.stackGroup==="coins"&&qa.includes(d.slug))continue;let g=d.id,h=d.container,p=u(h),m=r(S=>{i[p.id]??=[],i[p.id].push(S)},"addOrphan");if(d.isOfType("backpack")){p.containers.push(d),c.add(d),u(d);continue}let y=d.handsHeld,b=l.hands.filter(Boolean).length;if(y===2&&b===0){a.equipped.hands[0]===g?l.hands=[d,d]:m(d);continue}if(y===1&&b<=1){let S=a.equipped.hands.indexOf(g);De(S)?l.hands[S]=d:m(d);continue}if(!l.armor[0]&&d.isOfType("armor")&&d.isEquipped){a.equipped.armor[0]===g?l.armor[0]=d:m(d);continue}if((d.isOfType("equipment")||_e(d))&&ht(d)){let S=a.equipped.others[g];De(S)?l.others[S]=d:m(d);continue}let v=a.tabs[p.id]?.[g];if(De(v)){p.matrix[v]=d;continue}m(d)}for(let d of s){let g=i[d.id];if(g){for(let h of g){let p=h.handsHeld,m=l.hands.filter(Boolean).length;if(m===0&&p===2){l.hands=[h,h];continue}if(m<=1&&p===1){let y=l.hands[0]?1:0;l.hands[y]=h;continue}if(!l.armor[0]&&h.isOfType("armor")&&h.isEquipped){l.armor[0]=h;continue}if((h.isOfType("equipment")||_e(h))&&ht(h)){l.others.push(h);continue}d.matrix.push(h)}d.matrix=d.matrix.filter(Boolean)}}for(let d of s){let g=d.parent;for(;g;)d.parents.push(g),g=g.container;d.parents.reverse();let h=[d.containers,d.parents,d.item].flat();d.trailings=c.filter(p=>!h.includes(p))}s.size||u(void 0),l.others=l.others.filter(Boolean);let f=B(t,"inventory.activeTab");return{tabs:Array.from(s.values()),equipped:l,actor:e,selectedTab:s.get(f)?.id,containerBulk:d=>{let g=d.capacity;return`${g.value.toString()} / ${g.max.toString()}`}}}r(Ga,"getData");function za(e,t,n,o){let a=e.find("[data-tab-id]");for(let c of e.find("[data-container-id]"))c.addEventListener("click",l=>{let u=c.dataset.containerId;a.removeClass("active"),a.filter(`[data-tab-id=${u}]`).addClass("active"),G(t,"inventory.activeTab",u)});let s=o.find("#pf2e-toobelt-inventory-item-details")[0],i=e.find("[data-item-id], [data-container-id]");for(let c of i)c.addEventListener("mouseenter",l=>Wa(l,n,c,s)),c.addEventListener("mouseleave",l=>{s.classList.add("hidden")});n.isOwner&&(kt=randomID(),so({element:e[0],selector:"[data-item-id]",filter:"input",draggedClass:"dragged",ghostClass:"ghost",identifier:kt,cursorImage:{id:"pf2e-toolbelt-inventory-cursor-image",img:c=>c.dataset.itemImg},createGhost:Ya,onDragStart:()=>Va(s),onDragEnd:(c,l,u)=>Ka(t,u),droppables:[es(e,t),Za(e,t),Xa(e,t),Qa(e,t),Ja(e,t)]}))}r(za,"addEvents");async function Wa(e,t,n,o){if(Tt)return;let a=n.dataset.details;if(!a){let s=ae(t,n);if(!s)return;a=await R("inventory/details",{item:s}),n.dataset.details=a}o.innerHTML=a,o.classList.remove("hidden")}r(Wa,"onItemDetails");function Va(e){Tt=!0,e.classList.add("hidden")}r(Va,"onDragStart");function Ka(e,{dropped:t,canceled:n}){Tt=!1,!(n||!t)&&G(e,"inventory.requireSave",!0)}r(Ka,"onDragEnd");function Ya(e,t){return e.parentElement.dataset.area==="items-grid"?{element:e,index:t}:void 0}r(Ya,"createGhost");function Xe(e){return e.identifier===kt?!0:(K("inventory.identifier.error"),!1)}r(Xe,"checkIdentifier");function Ja(e,t){function n(a,s,i){if(i.element===s.element||i.element===s.ghost)return;let c=s.ghost,l=xe(i.element),u=c.index>=l?i.element:i.element.nextElementSibling;i.element.parentElement.insertBefore(c.element,u),c.index=l}r(n,"onDragEnter");function o(a,s,i){let c=i.element.parentElement;!c||Ee(i.triggeringElement,c,{selector:"[data-item-id]"})||!c.parentElement.contains(i.triggeringElement)||(c.appendChild(s.ghost.element),s.ghost.index=1/0)}return r(o,"onDragLeave"),{element:e[0],selector:"[data-area='items-grid'] [data-item-id]",onDragEnter:n,onDragLeave:o}}r(Ja,"itemsGridDroppable");function Qa(e,t){let n=t.actor;function o(i,c,l){Ee(l.triggeringElement,l.element,{selector:"[data-item-id]"})||l.element.querySelector("[data-area='items-grid']").appendChild(c.ghost.element)}r(o,"onDragEnter");function a(i,c,l){c.ghost.reset()}r(a,"onDragLeave");async function s(i,c,l){if(!Xe(c))return!1;let u=ae(n,c);if(!u)return!1;let f=[];return c.element===c.ghost.element?(c.ghost.classList.purge(),go(c.element)):(re({html:e,updates:f,item:u,...c,target:c.ghost.element}),Dt(e,n),c.ghost.reset()),await n.updateEmbeddedDocuments("Item",f),!0}return r(s,"onDrop"),{element:e[0],selector:"[data-area='items-list']",onDragEnter:o,onDragLeave:a,onDrop:s}}r(Qa,"itemsListDroppable");function Xa(e,t){let n=t.actor,o=e.find("[data-equipped-slot=right-hand]")[0];function a(u,f){let d=f.element.dataset.equippedSlot;if(d===u.parent.dataset.equippedSlot||f.element.querySelector("[data-two-hands]"))return{canDrop:void 0};let g=ae(n,u);if(!g)return{canDrop:!1};let h=d==="armor"?g.isOfType("armor"):!0;return{item:g,slot:d,canDrop:h}}r(a,"getData");function s({updates:u,item:f,element:d,drop:g,noTwoHand:h=!1,noUpdate:p=!1}){let m=g instanceof HTMLElement?g:g.element,y=m.dataset.equippedSlot,b=d instanceof HTMLElement?d:d.element,v=bn(f),S=He(f),T=gt(f);m.appendChild(b);let O=r((N,q,H,P)=>{p||u.push(Ue(f,{carryType:N,handsHeld:q,inSlot:H,invested:P,containerId:null})),b.classList.toggle("invested",T&&P)},"move");if(y==="armor"){O("worn",0,!0,!0);return}if(y==="right-hand"){O("held",1,!1,v);return}O("held",S&&!h?2:1,!1,$e(f)&&(!S||!h))}r(s,"moveItemToSlot");function i(u){let d=(u instanceof HTMLElement?u:u.element).querySelector("[data-item-id]"),g=ae(n,d);return{element:d,item:g}}r(i,"getSlottedItem");function c(u,f,d){let{canDrop:g}=a(f,d);g!==void 0&&(d.classList.toggle("valid",g),d.classList.toggle("invalid",!g))}r(c,"onDragEnter");async function l(u,f,d){if(!Xe(f))return!1;let{item:g,canDrop:h,slot:p}=a(f,d);if(!h)return!1;let m=[],y=i(d),b=f.parent.dataset.area,v=f.parent.dataset.equippedSlot,S=He(g),T=!1;if(b==="equipped")y.item&&re({html:e,updates:m,...y});else if(b==="items-grid"){if(p==="left-hand"&&S){let O=i(o);O.item&&re({html:e,updates:m,...O})}y.item&&re({html:e,updates:m,...y,target:f.element})}else p==="armor"?y.item&&s({updates:m,...y,drop:f.parent}):v==="armor"?y.item&&(y.item.isOfType("armor")?s({updates:m,...y,drop:f.parent}):re({html:e,updates:m,...y})):p==="right-hand"?(T=!0,y.item&&s({updates:m,...y,drop:f.parent,noUpdate:!0,noTwoHand:!0})):y.item&&(S?re({html:e,updates:m,...y}):(s({updates:m,...y,drop:f.parent,noUpdate:!0}),T=!0));return s({updates:m,item:g,element:f,drop:d,noUpdate:T}),(p==="left-hand"||v==="left-hand")&&Dt(e,n),await n.updateEmbeddedDocuments("Item",m),!0}return r(l,"onDrop"),{element:e.find("[data-area=equipped] .main-items")[0],selector:"[data-equipped-slot]",purgeOnLeave:!0,onDragEnter:c,onDrop:l}}r(Xa,"largeEquipmentDroppable");function Za(e,t){let n=t.actor;function o(i,c){if(i.parent===c.element)return{canDrop:void 0};let l=ae(n,i);if(!l.isIdentified||!(l.isOfType("equipment")||_e(l)))return{canDrop:!1};let u=gt(l),f=yn(l);return!u&&!f?{canDrop:!1}:{canDrop:!0,item:l,canInvest:u}}r(o,"getData");function a(i,c,l){let{canDrop:u,canInvest:f}=o(c,l);u!==void 0&&(l.classList.add("show"),l.classList.toggle("add-forbidden",!u),l.classList.toggle("add-invest",u&&f),l.classList.toggle("add-equip",u&&!f))}r(a,"onDragEnter");async function s(i,c,l){if(!Xe(c))return!1;let{canDrop:u,canInvest:f,item:d}=o(c,l);return u?(l.element.appendChild(c.element),c.element.classList.toggle("invested",f),await n.updateEmbeddedDocuments("Item",[Ue(d,{containerId:null,inSlot:!0,invested:!0})]),!0):!1}return r(s,"onDrop"),{element:e.find("[data-area=equipped]")[0],filter:".main-items",purgeOnLeave:!0,onDragEnter:a,onDrop:s}}r(Za,"otherEquipmentDroppable");function es(e,t){let n=t.actor;function o(i,c){let l=ae(n,i);if(!l)return{canDrop:!1};let u=c.element.dataset.containerId;if(u==="undefined")return{item:l,canDrop:!0};let f=n.items.get(u);if(!f)return{canDrop:!1};let d=f.capacity,g=d.max.minus(d.value);return{item:l,container:f,canDrop:g.value>=l.bulk.value}}r(o,"getData");function a(i,c,l){let{canDrop:u}=o(c,l);l.classList.toggle("valid",u),l.classList.toggle("invalid",!u)}r(a,"onDragEnter");async function s(i,c,l){if(!Xe(c))return!1;let{canDrop:u,item:f,container:d}=o(c,l);if(!u)return!1;let g=re({html:e,updates:[],item:f,element:c,target:d});return c.parent.dataset.equippedSlot==="left-hand"&&Dt(e,n),await n.updateEmbeddedDocuments("Item",g),!0}return r(s,"onDrop"),{element:e[0],selector:"[data-container-id]",filter:".back",purgeOnLeave:!0,onDragEnter:a,onDrop:s}}r(es,"containersDroppable");function go(e){e.classList.remove("invested"),e.querySelector(".vignette.hands")?.remove()}r(go,"cleanContainerItem");function re({html:e,updates:t,item:n,element:o,target:a}){let s=a instanceof HTMLElement,i=o instanceof HTMLElement?o:o.element,c=s?a.closest("[data-tab-id]").dataset.tabId:a instanceof Item?a.id:a;return go(i),s?a.before(i):e.find(`.container-tab[data-tab-id=${c}] [data-area=items-grid]`).append(i),c=[void 0,"undefined"].includes(c)?null:c,t.push(Ue(n,{containerId:c,inSlot:!1,invested:!1,carryType:c?"stowed":"worn",handsHeld:0})),t}r(re,"moveItemToContainer");function Dt(e,t){let n=e.find("[data-area='equipped'] .main-items")[0],o=n.querySelector("[data-equipped-slot='left-hand']"),a=n.querySelector("[data-equipped-slot='right-hand']"),s=o.querySelector("[data-item-id]"),i=a.querySelector(".item:not(.fake)"),c=ae(t,s),l=!!c&&He(c);if(!l&&i?.dataset.twoHands)i.remove();else if(l&&!i){let u=s.cloneNode(!0);u.dataset.twoHands="true",a.appendChild(u)}}r(Dt,"checkForTwoHandedSlots");function ae(e,t){if(!t)return;let n=t instanceof HTMLElement?t:t.element,{itemId:o,containerId:a}=n.dataset,s=o??a;if(s)return e.items.get(s)}r(ae,"getItemFromElement");var ho=D("knowledges.editLore"),Ze=class extends FormApplication{static{r(this,"EditLores")}get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return ho("title",this.actor)}get template(){return V("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:E(n,"knowledges.unspecified")??"",specific:E(n,"knowledges.specific")??"",i18n:ho.template})}async _updateObject(t,{unspecified:n,specific:o}){let a=this.object;z(a,"knowledges.unspecified",n.trim()),z(a,"knowledges.specific",o.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};var yo=A("renderNPCSheetPF2e",ts);function bo(){return{settings:[{key:"knowledges",type:Boolean,default:!1,onChange:e=>yo(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&I("knowledges")&&yo(!0)}}}r(bo,"registerKnowledges");function ts(e,t){let n=e.actor;_(n)&&(os(n,t),as(t),rs(n,t))}r(ts,"renderNPCSheetPF2e");function xt(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}r(xt,"knowledgeSelector");function ns(e){new Ze(e).render(!0)}r(ns,"editLores");function os(e,t){let n=E(e,"knowledges.unspecified"),o=E(e,"knowledges.specific");if(!n&&!o)return;let a=e.identificationDCs.lore,s=xt(t,"body","");s.find(".identification-skills").last().remove();function i(l,u,f){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:f})}</div>`}r(i,"tag");function c(l,{dc:u,start:f}){let d=l.split(",").filter(g=>g.trim()).map(g=>i(g,u,f)).join("");s.append(d)}r(c,"addTags"),c(n||"Unspecific",a[0]),c(o||"Specific",a[1])}r(os,"replaceLores");function rs(e,t){xt(t,"header","button.edit").on("click",()=>ns(e))}r(rs,"addEvents");function as(e){let t=xt(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}r(as,"addEditButton");var se=D("merchant"),wo="CONFIG.Item.documentClass.prototype.prepareDerivedData",ss="CONFIG.PF2E.Actor.documentClasses.loot.prototype.transferItemToActor",is="CONFIG.PF2E.Actor.documentClasses.character.prototype.transferItemToActor",vo=100,So=5,Io=.1,cs=.1;function Eo(){return{settings:[{key:"merchant",type:Boolean,default:!1,requiresReload:!0}],init:e=>{I("merchant")&&(Hooks.on("renderLootSheetPF2e",(...t)=>ls(e,...t)),F(wo,us,"WRAPPER"),F(ss,fs,"OVERRIDE"),F(is,ds,"OVERRIDE"))}}}r(Eo,"registerMerchant");async function ls(e,t,n){let o=t.actor;if(!o?.isMerchant)return;let{noCoins:a=!1,priceRatio:s=1,infiniteStocks:i=!1,infiniteItems:c={}}=E(o,"merchant")??{};if(e){let f=await R("merchant/sheet",{noCoins:a,infiniteStocks:i,priceRatio:{value:Co(s),max:So,min:Io,step:cs},actorUUID:o.uuid,...se.i18n,flagPath:h=>te("merchant",h)}),d=n.find(".sheet-sidebar");d.find(".editor").before(f);let g=d.find(".better-merchant");g.find("[data-action=pull-from-browser]").on("click",h=>ps(h,o)),g.find("[data-action=open-equipment-tab]").on("click",h=>At())}let l=n.find(".content .sheet-body [data-item-types]").filter("[data-item-types!=treasure]"),u=i;if(i&&e)l.find(".quantity a").remove();else if(!i){let f=l.find("[data-item-id]"),d=se.path("infinite-item.tooltip");for(let g of f){let h=g.dataset.itemId,p=!!c[h];if(e){let m=$(`<a data-action="toggle-infinite-item" data-tooltip="${d}">
	<i class="${p?"fa-solid":"fa-duotone"} fa-infinity"></i>
</a>`)[0];if(g.querySelector(".item-controls").prepend(m),p)for(let y of g.querySelectorAll(".quantity a"))y.remove();m.addEventListener("click",y=>{let b=`merchant.infiniteItems.${h}`,v=E(o,b)??!1;z(o,b,!v)})}p&&(u=!0)}}u&&(n.find(".content .sheet-body .coinage .wealth h3:last span").html("-"),n.find(".content .sheet-body .total-bulk span").html(game.i18n.format("PF2E.Actor.Inventory.TotalBulk",{bulk:"-"})))}r(ls,"renderLootSheetPF2e");function us(e){e();try{if(!this.isOfType("physical")||this.isOfType("treasure"))return;let t=this.actor;if(!t?.isMerchant)return;let n=E(t,"merchant");if(!n)return;let{priceRatio:o,infiniteStocks:a,infiniteItems:s={}}=n;if(typeof o=="number"&&o!==1){let c=Co(o);this.system.price.value=this.system.price.value.scale(c)}(()=>{if(typeof a=="boolean"&&a)return!0;let c=s[this.id];return typeof c=="boolean"&&c})()&&(this.system.quantity=9999)}catch{Y("merchant",wo)}}r(us,"itemPrepareDerivedData");async function fs(...e){let[t,n,o,a,s=!1]=e,i=Actor.implementation.prototype;if(!(this.isOwner&&t.isOwner))return i.transferItemToActor.apply(this,e);if(this.isMerchant&&n.isOfType("physical")){let c=game.pf2e.Coins.fromPrice(n.price,o);if(await t.inventory.removeCoins(c))return E(this,"merchant.noCoins")||await n.actor.inventory.addCoins(c),i.transferItemToActor.apply(this,e);if(this.isLoot)throw ue("Loot transfer failed");return null}if(t.isMerchant&&n.isOfType("physical")){let c=game.pf2e.Coins.fromPrice(n.price,o/2);if(await t.inventory.removeCoins(c))return await n.actor.inventory.addCoins(c),i.transferItemToActor.apply(this,e);if(this.isLoot)throw ue("Loot transfer failed");return null}return i.transferItemToActor.apply(this,e)}r(fs,"lootTranferItemToActor");async function ds(...e){let[t,n,o,a,s=!1]=e,i=Actor.implementation.prototype;if(!(this.isOwner&&t.isOwner))return i.transferItemToActor.apply(this,e);if(t.isMerchant&&n.isOfType("physical")){let c=game.pf2e.Coins.fromPrice(n.price,o/2);if(await t.inventory.removeCoins(c))return await n.actor.inventory.addCoins(c),i.transferItemToActor.apply(this,e);if(this.isLoot)throw ue("Loot transfer failed");return null}return i.transferItemToActor.apply(this,e)}r(ds,"actorTranferItemToLoot");function At(){let e=game.pf2e.compendiumBrowser,t=e.tabs.equipment,n=t.isInitialized?t.filterData:void 0;e.openTab("equipment",n)}r(At,"opentEquipmentTab");function ps(e,t){let o=game.pf2e.compendiumBrowser.tabs.equipment;if(!o.isInitialized){se.warn("browser.noTab"),At();return}let a=o.currentIndex.length;if(a>vo){se.error("browser.limit",{limit:vo}),At();return}let s=t.name,i=se("browser.dialogMsg",{nb:a,name:s});Dialog.confirm({content:`<div style="margin-bottom: 0.5em;">${i}</div>`,title:`${s} - ${se("browser.pull")}`,yes:async c=>{se.info("browser.wait");let l=(await sn(o)).filter(Boolean);t.createEmbeddedDocuments("Item",l)}})}r(ps,"pullFromBrowser");function Co(e){return Math.clamped(e,Io,So)}r(Co,"clampRatio");function et(e){let t=e.id,n=E(e,"target.save");n&&Hooks.once("preCreateChatMessage",o=>{he(o,"target.messageId",t),he(o,"target.save",n)})}r(et,"bindOnPreCreateSpellDamageChatMessage");var Ot=D("merge.multi"),tt=class extends Application{static{r(this,"MultiCast")}#e;#t;constructor(t,n,o){super(o),this.#t=t,this.#e=n}get title(){return Ot("title",this.#e.item)}get template(){return V("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:Ot.template})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#n.bind(this)),t.find("[data-action=cancel]").on("click",this.#o.bind(this))}async#n(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){Ot.error("zero"),this.close();return}let o=this.#e;if(!o)return;let a=o.item,s=o.actor;if(!s||!a)return;let i=r((l,u)=>{for(let[f,d]of Object.entries(l))for(let g=0;g<n-1;g++){let h=randomID();if(l[h]=d,u.type==="interval"){let p=u.damage[f];p&&(u.damage[h]=p)}else if(u.type==="fixed")for(let p of Object.values(u.levels)){let m=p.damage[f];m&&(p.damage[h]=m)}}},"updateSource"),c=deepClone(o.flags.pf2e.casting?.embeddedSpell);if(c){let l=c.system.damage;c.system.heightening??={};let u=c.system.heightening;i(l,u);let f=new Item.implementation(c,{parent:s});f.trickMagicEntry=a.trickMagicEntry;let d=o.getFlag("pf2e","origin.variant.overlays"),g=o.getFlag("pf2e","origin.castRank")??a.rank;(f.loadVariant({overlayIds:d,castRank:g})??f).rollDamage(this.#t)}else{let l=a.toObject(),u=l.system.damage,f=l.system.heightening??{};i(u,f),a.clone({"system.damage":u,"system.heightening":f}).rollDamage(this.#t)}a.damageKinds.size&&et(o),this.close()}#o(t){t.preventDefault(),this.close()}};var Pt=A("renderChatMessage",Oo,ms);function Ao(){return{settings:[{key:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>Pt(e,"multi-cast")},{key:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>Pt(e,"merge-damage")}],init:e=>{Pt(!1,["multi-cast","merge-damage"],!0)}}}r(Ao,"registerMerge");function ms(){for(let{message:e,html:t}of ge(10))t.find("[data-action=multi-cast]").remove(),t.find("[data-action=merge-damage]").remove(),Oo(e,t)}r(ms,"updateMessages");function Oo(e,t){!game.user.isGM&&!e.isAuthor||(I("merge-damage")&&Mo(e)?hs(e,t):I("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&gs(e,t))}r(Oo,"renderChatMessage");function gs(e,t){if(!e.item)return;let o=t.find(".message-content .chat-card .owner-buttons .spell-button");o.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${x("merge.spell.button")}</button>`),o.find("[data-action=multi-cast]").on("click",a=>{new tt(a,e).render(!0)})}r(gs,"renderSpell");function hs(e,t){let n='<span class="pf2e-toolbelt-merge">';if(E(e,"merge.merged")){let i=x("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${i}">`,n+='<i class="fa-duotone fa-split"></i>'}let o=x("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${o}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let a=Do(e),s=xo(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",i=>{i.stopPropagation();for(let{message:c}of ge(5,e)){let l=xo(c);if(!(!Mo(c)||Do(c)!==a||!lt(s?.map(u=>u.actor).filter(Boolean),l?.map(u=>u.actor).filter(Boolean)))){bs(i,e,c,{actorUUID:a,targetUUIDs:s});return}}M("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",i=>{i.stopPropagation(),ys(i,e)})}r(hs,"renderDamage");async function ys(e,t){let n=E(t,"merge.data").flatMap(o=>o.source);await Po(t.id),await ChatMessage.implementation.createDocuments(n)}r(ys,"splitDamages");async function bs(e,t,n,{actorUUID:o,targetUUIDs:a}){let s={},i=ko(n).concat(ko(t));for(let{name:p,notes:m,outcome:y,modifiers:b,tags:v}of i){s[p]??={name:p,tags:v,notes:new Set,results:[]};for(let T of m)s[p].notes.add(T);s[p].results.some(T=>T.outcome===y&&lt(T.modifiers,b))||s[p].results.push({outcome:y,modifiers:b})}let c=Object.values(s).map(p=>{p.label=p.name;for(let m of p.results)m.outcome&&(m.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${m.outcome}`));return p});c.at(-1).isLastGroup=!0;let l=await R("merge/merged",{groups:c,hasMultipleGroups:c.length>1}),u=To(t),f=To(n),d=[];for(let p of[].concat(f,u)){let{options:m,total:y,terms:b}=p,v=b[0],S=p.formula.replaceAll(/(\[[\w,-]+\])/g,"").replace(/^\(/,"").replace(/\)$/,""),T=d.find(({options:{flavor:O,critRule:N}})=>O===m.flavor&&N===m.critRule);T?(T.terms.push(v),T.total+=y,T.formulas.push(S)):d.push({options:m,formulas:[S],total:y,terms:[v]})}let g=hn();for(let p of d){if(p.options.flavor.includes("persistent")){let{index:m}=p.formulas.reduce((y,b,v)=>{let S=new g(b).expectedValue;return S<=y.value?y:{value:S,index:v}},{value:0,index:-1});p.formulas=[p.formulas[m]],p.terms=[p.terms[m]]}p.formula=`(${p.formulas.join(" + ")})[${p.options.flavor}]`,p.term=p.terms.length<2?p.terms[0]:Ro(p.terms)}let h={class:"DamageRoll",options:{},dice:[],formula:`{${d.map(({formula:p})=>p).join(", ")}}`,total:d.reduce((p,{total:m})=>p+m,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:d.map(({formula:p})=>p),modifiers:[],rolls:d.map(({options:p,formula:m,total:y,term:b})=>({class:"DamageInstance",options:p,dice:[],formula:m,total:y,terms:[b],evaluated:!0})),results:d.map(({total:p})=>({result:p,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let p=r(m=>{if("results"in m)for(let y of m.results)y.hidden=!0;else{let y=(m.term??m).operands??[];for(let b of y)p(b)}},"setHidden");for(let m of h.terms[0].rolls)for(let y of m.terms)p(y)}await Po(t.id,n.id),await ChatMessage.implementation.create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[k.id]:{merge:{actor:o,targets:a,merged:!0,type:"damage-roll",data:i},target:{targets:a}},pf2e:{context:{options:Array.from(new Set(i.flatMap(p=>p.itemTraits)))}}},rolls:[h]})}r(bs,"mergeDamages");function ko(e){let t=E(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let o=$(`<div>${e.flavor}</div>`),a=o.find("h4.action + .tags").prop("outerHTML"),s=[];o.find(".tag.tag_transparent").each(function(){s.push(this.innerHTML)});let i=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>/^(item|self):/.test(c)),modifiers:s,tags:a,notes:i}]}r(ko,"getMessageData");function Po(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}r(Po,"removeChatMessages");function Ro(e){let t=deepClone(e[0].options);for(let n of e)n.options={};return{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?Ro(e):e[0]]}}}r(Ro,"createTermGroup");function To(e){return E(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}r(To,"getMessageRolls");function Do(e){return E(e,"merge.actor")??e.actor?.uuid}r(Do,"getActorUUID");function xo(e){let t=E(e,"target.targets");if(t)return t;let n=E(e,"merge.targets")??e.getFlag("pf2e","target");return Array.isArray(n)?n:n?[n]:[]}r(xo,"getTargetUUIDs");function Mo(e){return E(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}r(Mo,"isDamageRoll");var Lo="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function Fo(){return{settings:[{key:"nobulk",type:Boolean,default:!1,requiresReload:!0},{key:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{I("nobulk")&&Fn("nobulk",ws),I("nobulk-coins")&&F(Lo,vs,"WRAPPER")}}}r(Fo,"registerNobulk");function vs(e){e();try{this.isCoinage&&(this.system.bulk.value=0)}catch{Y("nobulk",Lo)}}r(vs,"treasurePrepareBaseData");function ws(){let e=this.inventory.bulk.constructor,t=null;Object.defineProperty(this.inventory.bulk,"value",{get(){return t||(t=e.computeTotalBulk(this.actor.inventory.filter(n=>!n.isInContainer&&n.system.equipped.carryType!=="dropped"),this.actor.size),t)}})}r(ws,"actorPrepareEmbeddedDocuments");var Ss="CONFIG.Actor.documentClass.prototype.prepareData",Is="DocumentSheet.prototype._renderInner";function $o(){return{settings:[{key:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{I("share")!=="disabled"&&(F(Ss,xs,"WRAPPER"),F(Is,Es,"WRAPPER"),Hooks.on("preUpdateActor",ks),Hooks.on("deleteActor",Cs),Hooks.on("updateActor",Ts))}}}r($o,"registerShare");async function Es(e,...t){let n=await e(...t);if(!Ae(this,"CreatureConfig"))return n;let o=this.actor;if(!_(o)||!o.isOfType("character","npc")||Ce(o).size)return n;let a=game.actors.filter(i=>i.id!==o.id&&i.isOwner&&ot(i)).map(i=>({key:i.id,label:i.name})),s=await R("share/master",{masters:a,master:E(o,"share.master"),selectPath:te("share.master"),i18n:D("share.templates.master")});return n.children().last().before(s),n}r(Es,"documentSheetRenderInner");function Cs(e){No(e);let t=Ce(e);Promise.all(t.map(async n=>{Uo(n),await Bt(n,"share.master")}))}r(Cs,"deleteActor");function ks(e,t){let n=ut(t,"share");if(n?.master){let o=game.actors.get(n.master);if(ot(o)){let a=deepClone(o._source.system.attributes.hp);setProperty(t,"system.attributes.hp",a)}}else{let o=nt(e),a=getProperty(t,"system.attributes.hp");o&&a&&(o.update({system:{attributes:{hp:a}}},{noHook:!0}),delete t.system.attributes.hp)}}r(ks,"preUpdateActor");function Ts(e,t,n,o){let a=game.user.id===o,s=ut(t,"share");if(s?.master!==void 0){let c=e;if(No(c),s.master){let l=game.actors.get(s.master);ot(l)&&(Ho(c,l),_o(l,c))}else Uo(c)}if(!a)return;let i=Ce(e);if(i.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(i.map(async u=>await u.update(l,{noHook:!0})))}else Promise.all(i.map(async l=>await Ds(l,t)))}}r(Ts,"updateActor");async function Ds(e,t){I("share")==="force"?await z(e,"toggle",!E(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}r(Ds,"refreshActor");function xs(e){e();let t=E(this,"share.master"),n=t?game.actors.get(t):void 0;if(!ot(n))return;nt(this)||(Ho(this,n),_o(n,this));let o=this.system.attributes.hp;Object.defineProperty(this.system.attributes,"hp",{get(){let a=n.system.attributes.hp;return As(a,o),o},enumerable:!0})}r(xs,"prepareData");function As(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}r(As,"transfertHpData");function Ce(e){return B(e,"share.slaves")??new Collection}r(Ce,"getSlaves");function Ho(e,t){return G(e,"share.master",t)}r(Ho,"setMaster");function Uo(e){return Te(e,"share.master")}r(Uo,"unsetMaster");function nt(e){return B(e,"share.master")}r(nt,"getMaster");function ot(e){return e&&e.type==="character"&&!nt(e)}r(ot,"isValidMaster");function _o(e,t){let n=Ce(e);return G(e,"share.slaves",n.set(t.id,t))}r(_o,"addSlaveToMaster");function No(e){let t=nt(e);if(!t)return;Ce(t).delete(e.id)}r(No,"removeSlaveFromMaster");var Os=A("renderCharacterSheetPF2e",Hs),Ps=A("deleteCombat",_s),Rs=A("deleteCombatant",Vo),Ms=A("createCombatant",Ns),Ls=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Fs=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),$s=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function jo(){return{name:"stances",settings:[{key:"stances",type:Boolean,default:!1,scope:"client",onChange:qo}],conflicts:["pf2e-stances"],api:{getStances:Rt,toggleStance:Wo,isValidStance:Bo},ready:e=>{I("stances")&&qo(!0)}}}r(jo,"registerStances");function qo(e){Os(e),Ps(e),Rs(e),Ms(e)}r(qo,"setup");function Bo(e){return e?.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}r(Bo,"isValidStance");function Rt(e){let t=[],n=new Set;for(let{replace:o,sourceId:a,effectUUID:s,effect:i,img:c,name:l,itemName:u,action:f}of Go(e)){o&&n.add(o);let d=f?Oe(e,f,"action"):Oe(e,a,"feat");t.push({name:l,itemName:u,uuid:a,img:c,effectUUID:s,effectID:i?.id,actionUUID:d.sourceId,actionID:d.id})}return t.filter(({uuid:o})=>!n.has(o))}r(Rt,"getStances");async function Hs(e,t){let n=e.actor;if(!_(n))return;let o=Rt(n);if(!o.length)return;let a=n.getActiveTokens(!0,!0).some(l=>l.inCombat),s=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),i=s.find(".actions-options"),c=await R("stances/sheet",{stances:o,canUseStances:a&&!n.isDead,i18n:D("stances")});i.length?i.after(c):s.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>Us(l,n))}r(Hs,"renderCharacterSheetPF2e");function Us(e,t){let n=e.currentTarget,o=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!o)return;let a=n.dataset.effectUuid;Wo(t,a)}r(Us,"onToggleStance");function*Go(e){for(let t of e.itemTypes.feat){let n=t.sourceId,o=Fs.get(n),a=$s.get(n);if(!o&&!a&&!Bo(t))continue;let s=o?.effect??a?.effect??t.system.selfEffect.uuid,i=fromUuidSync(s);i&&(yield{name:(o&&fromUuidSync(o.replace)?.name)??t.name,itemName:t.name,replace:o?.replace,extra:a,sourceId:n,effectUUID:s,effect:Oe(e,s,"effect"),action:a?.action,img:i.img})}}r(Go,"actorStances");function zo(e){let t=[];for(let{effect:n}of Go(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}r(zo,"getStancesEffects");async function Wo(e,t){let n=zo(e),o=n.findIndex(s=>s.uuid===t),a=!1;if(o===-1)a=!0;else{let s=n.filter(c=>c.uuid!==t).length,i=n.filter(c=>c.uuid===t).length>1;(s||i)&&n.splice(o,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(s=>s.id)),a&&Mt(e,t)}r(Wo,"toggleStance");async function Mt(e,t){let n=await fromUuid(t);if(n){let o=n.toObject();return getProperty(o,"flags.core.sourceId")||setProperty(o,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[o]))[0]?.toMessage(),!0}return!1}r(Mt,"addStance");function _s(e){for(let t of e.combatants)Vo(t)}r(_s,"deleteCombat");function Vo(e){let t=Ko(e);if(t){if(!game.user.isGM&&ct(t)){let n=zo(t).map(o=>o.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}me(t)}}r(Vo,"deleteCombatant");function Ns(e){let t=Ko(e);t&&(!game.user.isGM&&ct(t)&&qs(t),me(t))}r(Ns,"createCombatant");function Ko(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}r(Ko,"getActorFromCombatant");async function qs(e){let t=Rt(e);if(!(!t.length||t.filter(({effectID:a})=>a).length||!Kt(e,Ls,["feat"])))if(t.length===1){let a=t[0];await Mt(e,a.effectUUID)&&le("stances.useStance",{stance:a.name})}else js(e,t)}r(qs,"checkForSavant");async function js(e,t){let n=D("stances.menu");new Dialog({title:n("title"),content:await R("stances/menu",{stances:t,i18n:n.template}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:o=>Mt(e,o.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}r(js,"openStancesMenu");function Jo(){return{settings:[{key:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>Yo(e)}],conflicts:["pf2e-spells-summary"],ready:e=>{Yo()}}}r(Jo,"registerSpellsSummary");function Yo(e){(e??I("summary"))!=="disabled"?Be({tabName:"spellcasting",templateFolder:"summary/sheet",getData:Xs,addEvents:Bs}):Ge("spellcasting")}r(Yo,"setup");function Bs(e,t,n){let o=e.find(".spell-type .uses .spell-slots-input input");o.on("change",a=>Gs(a,n)),o.on("focus",zs),o.on("blur",Ws),e.find(".focus-pips").on("click contextmenu",a=>Vs(a,n)),e.find(".spell-slots-increment-reset").on("click",a=>Ys(a,t,n)),e.find(".item-image").on("click",a=>Js(a,n))}r(Bs,"addEvents");async function Gs(e,t){e.preventDefault();let{inputPath:n,entryId:o}=$(e.currentTarget).data(),a=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:o,[n]:a}])}r(Gs,"onUsesInputChange");function zs(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}r(zs,"onUsesInputFocus");function Ws(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}r(Ws,"onUsesInputBlur");function Vs(e,t){e.preventDefault();let n=e.type==="click"?1:-1,o=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":o})}r(Vs,"onToggleFocusPool");function Ks(e,t,n){if(game.modules.get("pf2e-staves")?.active){Qs(e.element).find(".directory-list.spellcastingEntry-list").find(`.item-container.spellcasting-entry[data-item-id=${n}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click();return}let o=game.modules.get("pf2e-dailies");if(!o?.active)return;let a=t.spellcasting.get(n);o.api.updateEntryCharges(a,9999)}r(Ks,"onChargesReset");function Ys(e,t,n){e.preventDefault();let{itemId:o,rank:a,isCharge:s}=$(e.currentTarget).data();if(!o)return;if(s){Ks(t,n,o);return}let i=n.items.get(o);if(i){if(i.isOfType("consumable")){let c=i.system.uses?.max;c&&i.update({"system.uses.value":c})}else if(i.isOfType("spellcastingEntry")){let c=a>=0&&a<=11?`slot${a}`:"slot0",l=i.system.slots?.[c];l&&i.update({[`system.slots.${c}.value`]:l.max})}else if(i.isOfType("spell")){let c=i.system.location.uses?.max;c&&i.update({"system.location.uses.value":c})}}}r(Ys,"onSlotsReset");async function Js(e,t){let{entryId:n,itemId:o,castRank:a}=e.currentTarget.closest(".item").dataset,s=t.spellcasting.collections.get(n);if(!s)return;s.get(o)?.toMessage(e,{data:{castRank:Number(a??NaN)}})}r(Js,"onItemToChat");function Qs(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}r(Qs,"getSpellcastingTab");async function Xs(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,o=game.modules.get("pf2e-dailies"),a=o?.active,s=n||a&&isNewerVersion(o.version,"2.14.0"),i=n?"flags.pf2e-staves.charges":a?"flags.pf2e-dailies.staff.charges":"",c=[],l=[],u,f=!1,d=await Promise.all(e.spellcasting.collections.map(async g=>({entry:g.entry,data:await g.entry.getSheetData({spells:g})})));for(let{entry:g,data:h}of d){if(h.isRitual){u=h.groups.flatMap((P,j)=>P.active.map(({spell:L})=>({name:L.name,img:L.img,slotId:j,itemId:L.id,rank:L.rank,time:L.system.time.value})).filter(Boolean));continue}let p=h.id,m=h.statistic.dc.value,y=h.name,b=h.isFocusPool,v=g.system?.prepared?.value==="charge",S=h.isInnate,T=h.isPrepared,O=h.isSpontaneous,N=h.isFlexible,q=(()=>{if(h.category!=="items")return;let P=g.id.split("-")[0];return e.items.get(P)})(),H=(()=>{if(!v)return;let P=a&&o.api.getSpellcastingEntryStaffData(g),{charges:j,max:L,canPayCost:C}=P??getProperty(g,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:j,max:L,noMax:!0,canPayCost:C??(()=>!0)}})();for(let P of h.groups){if(!P.active.length||P.uses?.max===0)continue;let j=[],L=P.id==="cantrips",C=vn(P.id),ie=!L&&v&&!s;for(let J=0;J<P.active.length;J++){let st=P.active[J];if(!st||st.uses?.max===0)continue;let{spell:ee,expended:hr,virtual:yr,uses:br,castRank:vr}=st;j.push({name:ee.name,img:ee.img,range:ee.system.range.value||"-",castRank:vr??ee.rank,slotId:J,entryId:p,entryDc:m,entryName:y,itemId:ee.id,inputId:S?ee.id:h.id,inputPath:q?"system.uses.value":v?i:S?"system.location.uses.value":`system.slots.slot${C}.value`,isCharge:v,isActiveCharge:v&&s,isBroken:ie,isVirtual:yr,isInnate:S,isCantrip:L,isFocus:b,isPrepared:T,isSpontaneous:O||N,groupId:P.id,consumable:q,uses:q?q.system.uses:v?H:br??P.uses,expended:v&&!L?!H.canPayCost(C):hr??(b&&!L?t.value<=0:!1),action:ee.system.time.value,type:q?`PF2E.Item.Consumable.Category.${q.category}`:v?be("summary.staff"):S?"PF2E.PreparationTypeInnate":O?"PF2E.PreparationTypeSpontaneous":N?"PF2E.SpellFlexibleLabel":b?"PF2E.TraitFocus":"PF2E.SpellPreparedLabel",order:v?0:T?1:b?2:S?3:O?4:5,noHover:T||L||ie||b})}if(j.length){if(b)if(L)f=!0;else{l.push(...j);continue}c[C]??=[],c[C].push(...j)}}}if(c.length){let g=I("summary")==="sort"?(h,p)=>h.order===p.order?Pe(h.name,p.name):h.order-p.order:(h,p)=>Pe(h.name,p.name);for(let h of c)h&&h.sort(g)}return l.length&&(l.sort((g,h)=>Pe(g.name,h.name)),c[12]=l,f=!1),{spells:c,rituals:u,focusPool:t,hasFocusCantrips:f,isOwner:e.isOwner,i18n:D("summary"),entryRank:g=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ln(g)})}}r(Xs,"getData");var Zs={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Lt={hero:{icon:"fa-solid fa-hospital-symbol",reroll:"PF2E.RerollMenu.HeroPoint",rerolled:"PF2E.RerollMenu.MessageHeroPoint"},new:{icon:"fa-solid fa-dice",reroll:"PF2E.RerollMenu.KeepNew",rerolled:"PF2E.RerollMenu.MessageKeep.new"},lower:{icon:"fa-solid fa-dice-one",reroll:"PF2E.RerollMenu.KeepLower",rerolled:"PF2E.RerollMenu.MessageKeep.lower"},higher:{icon:"fa-solid fa-dice-six",reroll:"PF2E.RerollMenu.KeepHigher",rerolled:"PF2E.RerollMenu.MessageKeep.higher"}},ei=["criticalFailure","failure","success","criticalSuccess"],ti=A("preCreateChatMessage",ii),Zo=An("renderChatMessage",or),er=A("createMeasuredTemplate",ai),rt=fe("target",oi);function tr(){return{settings:[{key:"target",type:Boolean,default:!1,requiresReload:!0},{key:"target-client",type:String,default:"disabled",choices:["disabled","small","big"],scope:"client",onChange:e=>Zo(e&&I("target"))},{key:"target-template",type:Boolean,default:!1,scope:"client",onChange:e=>er(e&&I("target"))}],conflicts:[],init:e=>{!e||!I("target")||Hooks.on("getChatLogEntryContext",ri)},ready:e=>{if(I("target")){ni(e);for(let{message:t,html:n}of ge(10))or(t,n)}}}}r(tr,"registerTargetTokenHelper");function ni(e){ti(!0),Zo(!0),er(I("target-template")),e&&rt.activate()}r(ni,"setHooks");function oi(e){if(Re())switch(e.type){case"target.update-save":$t(e);break;case"target.update-applied":ur(e);break}}r(oi,"onSocket");function ri(e,t){let n=r(o=>{let a=o.data("messageId"),s=game.messages.get(a);if(!s)return;let i=B(s,"target");if(i)return{message:s,inMemory:i}},"getMessageData");t.unshift({icon:'<i class="fa-solid fa-dice-d20"></i>',name:be("target.chat.context.saves.name"),condition:o=>!!n(o)?.inMemory.canRollSave?.length,callback:o=>{let{inMemory:a,message:s}=n(o)??{},i=a.canRollSave;if(!i?.length)return;let c=ir(s);c&&lr({target:o.find(".pf2e-toolbelt-target-damage")[0]},s,c,i)}})}r(ri,"getChatLogEntryContext");async function ai(e,t,n){let o=game.user;if(o.id!==n)return;let a=D("target.menu"),s=e.item,i=e.actor,c=i?i.token??i.getActiveTokens()[0]:void 0,l={title:s?.name||a("title"),content:await R("target/template-menu",{i18n:a.template,noSelf:!c}),buttons:{select:{icon:'<i class="fa-solid fa-bullseye-arrow"></i>',label:a("target"),callback:m=>({targets:m.find("[name=targets]:checked").val(),self:m.find("[name=self]").prop("checked"),neutral:m.find("[name=neutral]").prop("checked")})}},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-toolbelt-target-template",width:260});if(!u)return;let f=i?i.alliance:o.isGM?"opposition":"party",d=f==="party"?"opposition":f==="opposition"?"party":null,p=Sn(e).filter(m=>{if(!m.actor?.isOfType("creature","hazard","vehicle")||m.document.hidden)return!1;if(c&&m===c)return u.self;let b=m.actor?m.actor.alliance:m.alliance;return b===null?u.neutral:u.targets==="all"||u.targets==="allies"&&b===f||u.targets==="enemies"&&b===d}).map(m=>m.id);o.updateTokenTargets(p),o.broadcastActivity({targets:p})}r(ai,"createMeasuredTemplate");var Qo;function si(e){return Qo??=(()=>{let t=[game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage"),game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage")];return new RegExp(`^<div>(${t.join("|")})</div>`)})(),Qo.test(e.flavor)}r(si,"isRegenMessage");function nr(e){return!e.rolls[0].options.evaluatePersistent}r(nr,"isValidDamageMessage");function ii(e){let t=e.isDamageRoll,n=[];if(!(t&&!nr(e))){if(t&&!E(e,"target")){let o=e.token,a=o?.actor,s=si(e),i=s?a?[{token:o.uuid,actor:a.uuid}]:[]:Array.from(game.user.targets.map(c=>({token:c.document.uuid,actor:c.actor.uuid})));if(n.push(["targets",i]),s&&n.push(["isRegen",!0]),e.rolls.length===2){let c=e.rolls.filter(f=>f.options),l=c.findIndex(f=>f.options.splashOnly),u=c.findIndex(f=>!f.options.splashOnly&&f.options.damage?.modifiers.some(d=>d.damageCategory==="splash"));l!==-1&&u!==-1&&n.push(["splashIndex",l])}}if(t||e.getFlag("pf2e","context.type")==="spell-cast"){let o=e.item,a=o&&o.type==="spell"&&o.system.defense?.save;if(a){let s=o.spellcasting?.statistic.dc.value;typeof s=="number"&&n.push(["save",{...a,dc:s}])}}n.length&&he(e,"target",n.reduce((o,[a,s])=>(o[a]=s,o),{}))}}r(ii,"preCreateChatMessage");async function or(e,t){let n=I("target-client")!=="disabled";if(Te(e,"target.canRollSave"),n&&e.isDamageRoll){if(!nr(e))return;await li(e,t),Xo(e);return}let o=e.item;if(!(!o||o.type!=="spell")){if(n&&!o.damageKinds.size){await ci(e,t,o),Xo(e);return}o.system.defense?.save&&Nt(e)&&t.find("[data-action=spell-damage]").on("click",()=>{et(e)})}}r(or,"renderChatMessage");function Xo(e){Promise.all([ui.chat,ui.chat._popout].map(async t=>{let n=t?.element[0]?.querySelector("#chat-log");!n||!t.isAtBottom&&e.user._id!==game.user._id||(await t._waitForImages(),n.scrollTop=n.scrollHeight)}));for(let t of Object.values(e.apps))t instanceof ChatPopout&&t.rendered&&t.setPosition()}r(Xo,"refreshMessage");async function ci(e,t,n){let o=await cr(e);if(!o)return;let{targets:a,save:s}=o,i=t.find(".message-content"),c=i.find(".card-buttons");if(game.user.isGM||e.isAuthor){let u=c.find("[data-action=spell-save]"),f=$('<div class="pf2e-toolbelt-target-wrapper"></div>'),d=x("target.chat.targets.tooltip"),g=$(`<button class="pf2e-toolbelt-target-targets" title="${d}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);g.on("click",h=>rr(h,e)),f.append(g),f.append(u),c.prepend(f)}if(n?.area&&!n.traits.has("aura")&&canvas.scene?.templates.some(f=>f.message===e&&f.isOwner)&&c.find(".owner-buttons .hidden.small").removeClass("hidden"),!a.length)return;let l=$('<div class="pf2e-toolbelt-target-spell"></div>');for(let{template:u}of a)l.append("<hr>"),l.append(u);i.after(l),sr(e,l,s)}r(ci,"renderSpellChatMessage");function rr(e,t){e.stopPropagation();let n=game.user.targets;z(t,"target.targets",Array.from(n.map(o=>({token:o.document.uuid,actor:o.actor.uuid}))))}r(rr,"addTargets");async function li(e,t){let n=await cr(e),o=t.find(".message-content"),a=o.find(".damage-application"),s=$('<div class="pf2e-toolbelt-target-buttons"></div>');if(n?.targets.length&&a.length){let f=r(()=>{let h=!!B(e,"target.expanded");g.toggleClass("collapse",h),a.toggleClass("hidden",!h)},"toggleDamageRow"),d=x("target.chat.toggle.tooltip"),g=$(`<button class="toggle" title="${d}">
    <i class="fa-solid fa-plus expand"></i>
    <i class="fa-solid fa-minus collapse"></i>
</button>`);f(),g.on("click",h=>{h.stopPropagation(),G(e,"target.expanded",!B(e,"target.expanded")),f()}),s.append(g)}if(n?.isRegen!==!0&&(game.user.isGM||e.isAuthor)){let f=x("target.chat.targets.tooltip"),d=$(`<button class="targets" title="${f}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);d.on("click",g=>rr(g,e)),s.append(d)}if(t.find(".dice-result .dice-total").append(s),!n?.targets.length)return;let i=a.clone();if(!i.length)return;i.removeClass("damage-application").addClass("target-damage-application"),I("target-client")!=="big"&&i.find("button").addClass("small"),i.find("[data-action]").each(function(){let f=this.dataset.action;this.dataset.action=`target-${f}`});let{targets:c,save:l}=n,u=$('<div class="pf2e-toolbelt-target-damage"></div>');for(let{uuid:f,template:d,save:g,isOwner:h,applied:p={}}of c){if(u.append("<hr>"),u.append(d),!h)continue;let m=!!(g?.result&&g.basic),y=i.clone();y.each((b,v)=>{v.dataset.rollIndex=b,v.dataset.targetUuid=f,v.classList.toggle("applied",!!p[b]||m&&g.result.success==="criticalSuccess"),m&&v.classList.add(g.result.success)}),u.append(y)}o.after(u),sr(e,u,l),u.find("button[data-action^=target-]").on("click",f=>gi(f,e))}r(li,"renderDamageChatMessage");function Ft(e){return e.target?.closest(".pf2e-toolbelt-target-damage")}r(Ft,"getRowsElement");function ar(e){Ft(e)?.classList.add("disable-saves")}r(ar,"disableSaveListeners");function fi(e){Ft(e)?.classList.remove("disable-saves")}r(fi,"enableSaveListeners");function sr(e,t,n){let o=r(a=>{let s=a.target.closest("[data-action]");if(!s)return;let i=s.dataset.action,c=r(()=>!Ft(a)?.classList.contains("disable-saves"),"saveEnabled");switch(i){case"ping-target":{mi(a);break}case"open-target-sheet":{pi(a);break}case"roll-save":{c()&&lr(a,e,n);break}case"reroll-save":{c()&&di(a,e,n);break}}},"listener");t.on("click",o)}r(sr,"addHeaderListeners");function ir(e){let t=E(e,"target.save");if(t)return{...t,...Zs[t.statistic]}}r(ir,"getSaveData");async function cr(e){let t=game.user.isGM,n=E(e,"target.targets")??[],o=t||game.settings.get("pf2e","metagame_showDC"),a=t||game.settings.get("pf2e","metagame_showBreakdowns"),s=t||game.settings.get("pf2e","metagame_showResults"),i=ir(e);if(!n.length&&!i)return;if(i){let u=game.i18n.format("PF2E.SavingThrowWithName",{saveName:game.i18n.localize(i.label)}),f=o?x("target.chat.save.dcWithValue",{dc:i.dc}):"";i.tooltipLabel=`${u} ${f}`,i.tooltip=await R("target/save-tooltip",{check:i.tooltipLabel})}let c=[],l=(await Promise.all(n.map(async({token:u})=>{let f=await fromUuid(u),d=f.id,g=f.actor;if(!g)return;let h=!g.hasCondition("undetected");if(!t&&!h)return;let p=g.isOwner,m=g.hasPlayerOwner,y=p||m,b=i&&!!g?.saves[i.statistic],v=E(e,`target.saves.${d}`);b&&!m&&!v&&c.push(u);let S=await(async()=>{if(!b||!v)return;let H=v.rerolled,P=b&&p&&!H,j=game.i18n.localize(`PF2E.Check.Result.Degree.Check.${v.success}`),L=v.value-i.dc,C=y||s?x(`target.chat.save.result.${o?"withOffset":y?"withoutOffsetWithDie":"withoutOffset"}`,{success:j,offset:L>=0?`+${L}`:L,die:`<i class="fa-solid fa-dice-d20"></i> ${v.die}`}):void 0;return{...v,canReroll:P,tooltip:await R("target/save-tooltip",{i18n:D("target.chat.save"),check:i.tooltipLabel,result:C,modifiers:y||a?v.modifiers:[],canReroll:P,rerolled:Lt[H]})}})(),T=i&&{...i,result:S},O=game.modules.get("anonymous"),N=t?!0:O?.active?O.api.playersSeeName(f.actor):!game.pf2e.settings.tokens.nameVisibility||f.playersCanSeeName,q=N?f.name:O?.active?O.api.getName(f.actor):x("unnamed");return{isOwner:p,canSeeName:N,hasPlayerOwner:m,uuid:u,target:f,save:T,applied:E(e,`target.applied.${d}`),template:await R("target/row-header",{name:q,isGM:t,isOwner:p,hasPlayerOwner:m,isHidden:!h,uuid:u,showSuccess:y||s,save:b&&T,canReroll:S?.canReroll,rerolled:Lt[S?.rerolled],i18n:D("target.chat.row")})}}))).filter(Boolean);return G(e,"target.canRollSave",c),t?l.sort((u,f)=>u.hasPlayerOwner-f.hasPlayerOwner):l.sort((u,f)=>!u.isOwner&&!f.isOwner?f.hasPlayerOwner-u.hasPlayerOwner:f.isOwner-u.isOwner),{targets:l,save:i,isRegen:E(e,"target.isRegen")}}r(cr,"getMessageData");async function at(e){let{targetUuid:t}=e.target.closest("[data-target-uuid]").dataset;return fromUuid(t)}r(at,"getTargetFromEvent");async function di(e,t,{dc:n}){let o=await at(e),a=o?.actor;if(!a)return;let s=E(t,`target.saves.${o.id}`);if(!s?.roll||s.rerolled)return;let i=a.isOfType("character")?a.heroPoints.value:0,c=Object.entries(Lt).map(([S,{icon:T,reroll:O}])=>{if(S==="hero"&&!i)return;let N=game.i18n.localize(O);return`<label><input type="radio" name="reroll" value="${S}"><i class="${T}"></i> ${N}</label>`}).filter(Boolean).join(""),l={yes:{icon:'<i class="fa-solid fa-rotate rotate"></i>',label:"reroll",callback:S=>S.find("[name=reroll]:checked").val()??null},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:"cancel",callback:()=>null}};ar(e);let u=await Dialog.wait({title:`${o.name} - ${x("target.chat.save.reroll.confirm.title")}`,content:c,buttons:l,close:()=>null},{id:`pf2e-toolbelt-target-save-reroll-dialog-${o.id}`});if(!u){fi(e);return}let f=u==="hero",d=f?"new":u;if(f){let{value:S,max:T}=a.heroPoints;if(S<1){M("target.chat.save.reroll.noPoints");return}await a.update({"system.resources.heroPoints.value":Math.clamped(S-1,0,T)})}let g=Roll.fromJSON(s.roll),h=g.clone();h.options.isReroll=!0,Hooks.callAll("pf2e.preReroll",Roll.fromJSON(s.roll),h,f,d);let p=await h.evaluate({async:!0});await yt(p),Hooks.callAll("pf2e.reroll",Roll.fromJSON(s.roll),p,f,d);let m=d==="higher"&&g.total>p.total||d==="lower"&&g.total<p.total?g:p;if(m===p){let S=new qe(p,n,s.dosAdjustments);m.options.degreeOfSuccess=S.value}let y=game.user.isGM||t.isAuthor,b={value:m.total,die:m.dice[0].total,success:m.degreeOfSuccess,roll:JSON.stringify(m.toJSON()),dosAdjustments:deepClone(s.dosAdjustments),modifiers:deepClone(s.modifiers),rerolled:u};m.options.keeleyAdd10&&b.modifiers.push({label:x("target.chat.save.reroll.keeley"),modifier:10});let v={type:"target.update-save",message:y?t:t.id,targets:[{target:o.id,data:b}]};game.user.isGM||t.isAuthor?$t(v):rt.emit(v)}r(di,"rerollSave");async function lr(e,t,{dc:n,statistic:o},a){let s=game.user.isGM||t.isAuthor,i=Array.isArray(a)?a.map(l=>fromUuid(l)):[at(e)],c={type:"target.update-save",message:s?t:t.id,targets:[]};ar(e),await Promise.all(i.map(async l=>{let u=await l,f=u?.actor;if(!f)return;let d=f.saves[o];if(!d)return;let g=(()=>{let p=t.item;if(p)return p;let m=E(t,"target.messageId");if(!m)return;let y=game.messages.get(m);if(y)return y.item})(),h=!game.user.settings.showCheckDialogs;return new Promise(p=>{d.check.roll({dc:{value:n},item:g,origin:f,skipDialog:e.shiftKey?!h:h,createMessage:!1,callback:async(m,y,b)=>{await yt(m);let v={value:m.total,die:m.dice[0].total,success:m.degreeOfSuccess,roll:JSON.stringify(m.toJSON()),dosAdjustments:b.getFlag("pf2e","context.dosAdjustments"),modifiers:b.getFlag("pf2e","modifiers").filter(S=>S.enabled).map(({label:S,modifier:T})=>({label:S,modifier:T}))};c.targets.push({data:v,target:u.id}),p()}})})})),s?$t(c):rt.emit(c)}r(lr,"rollSave");async function $t({targets:e,message:t}){if(typeof t=="string"&&(t=game.messages.get(t),!t))return;let n={};for(let{data:o,target:a}of e)typeof o.success=="number"&&(o.success=ei[o.success]),n[a]=deepClone(o);await z(t,"target.saves",n)}r($t,"updateMessageSave");async function pi(e){let t=await at(e);t&&t.actor?.sheet.render(!0)}r(pi,"openTargetSheet");async function mi(e){if(!canvas.ready)return;let t=await at(e);t&&canvas.ping(t.center)}r(mi,"pingTarget");async function gi(e,t){let n=e.currentTarget,{rollIndex:o,targetUuid:a}=n.closest("[data-target-uuid]").dataset,s=await fromUuid(a);if(!s)return;let i=n.dataset.action;if(i==="target-shield-block"){let l=t.id;n.classList.contains("shield-activated")||Le(l),requestAnimationFrame(()=>{gn(s,n,t.element)});return}mt({message:t,multiplier:i==="target-apply-healing"?-1:i==="target-half-damage"?.5:i==="target-apply-damage"?1:i==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:Number(o),tokens:[s],onDamageApplied:hi})}r(gi,"onTargetButton");function hi(e,t,n){let o={};for(let a of t){let s=a.id;ye(o,`target.applied.${s}.${n}`,!0);let i=E(e,"target.splashIndex");if(i!==void 0){let c=i===0?1:0;if(n===i)ye(o,`target.applied.${s}.${c}`,!0);else{ye(o,`target.applied.${s}.${i}`,!0);let l=E(e,"target.targets")??[];for(let u of l){let f=u.token?.split(".").at(-1);f!==s&&ye(o,`target.applied.${f}.${c}`,!0)}}}}game.user.isGM||e.isAuthor?ur({message:e,updates:o}):rt.emit({type:"target.update-applied",message:e.id,updates:o})}r(hi,"onDamageApplied");function ur({message:e,updates:t}){typeof e=="string"&&(e=game.messages.get(e),!e)||e.update(t)}r(ur,"updateMessageApplied");var ke=null,Z=null;function dr(){return{settings:[{key:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:fr}],conflicts:["pf2e-unided"],init:()=>{fr()}}}r(dr,"registerUnided");function fr(e){let t=e??I("unided");t==="disabled"?(ke&&(Hooks.off("preCreateItem",ke),ke=null),Z&&(Hooks.off("preUpdateItem",Z),Z=null)):(ke||(ke=Hooks.on("preCreateItem",yi)),t==="all"&&!Z?Z=Hooks.on("preUpdateItem",bi):t!=="all"&&Z&&(Hooks.off("preUpdateItem",Z),Z=null))}r(fr,"setHooks");function yi(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}r(yi,"preCreateItem");function bi(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}r(bi,"preUpdateItem");var vi=A("updateCombat",wi);function pr(){return{settings:[{key:"force-untarget",type:Boolean,default:!1,onChange:Ht},{key:"untarget",type:Boolean,default:!1,scope:"client",onChange:Ht}],init:()=>{Ht()}}}r(pr,"registerUntarget");function Ht(){vi(I("force-untarget")||I("untarget"))}r(Ht,"setup");function wi(e,t){if(!("turn"in t)&&!("round"in t))return;let n=game.user;n.updateTokenTargets(),n.broadcastActivity({targets:[]})}r(wi,"updateCombat");var pe=D("macros.condition");async function mr(e){let t=r((f,d)=>{let g=f.find("[name=condition]"),{name:h,slug:p,img:m}=g.find(":selected").data();return{type:d,slug:p,img:m,name:f.find("[name=name]").val().trim()||pe("effect-name",{condition:h}),uuid:g.val(),badge:Number(f.find("[name=badge]").val()||1),unidentified:f.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:pe("generate"),callback:f=>t(f,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:pe("add"),callback:f=>t(f,"add")}},o=Array.from(game.pf2e.ConditionManager.conditions.values()),a=new Set(o.filter(f=>!!f.badge).map(f=>f.slug)),s=await R("macros/condition",{i18n:pe.template,conditions:Array.from(new Set(o.sort((f,d)=>f.name.localeCompare(d.name))))}),i=r(f=>{let{name:d,slug:g}=f.find("[name=condition] :selected").data();f.find("[name=name]").prop("placeholder",pe("effect-name",{condition:d}));let h=a.has(g),p=f.find("[name=badge]");p.prop("disabled",!h),h||p.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:s,title:pe("title"),close:()=>null,render:f=>{i(f),f.find("[name=condition]").on("change",()=>i(f))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&a.has(c.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let u={name:c.name,type:"effect",img:c.img,system:{rules:[l],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(u):await e.createEmbeddedDocuments("Item",[u])}r(mr,"permaConditionEffect");nn("pf2e-toolbelt");var Ut=[Tn(),Fo(),tr(),_n(),bo(),dr(),Ao(),Rn(),Jo(),jo(),Bn(),$o(),pr(),po(),Pn(),Eo()],gr=new Set,_t=null;Hooks.once("init",()=>{let e=en(),t=Ut.flatMap(({settings:s})=>s??[]),n=t.filter(({scope:s})=>!s||s==="world"),o=t.filter(({scope:s})=>s==="client");for(let s of[n,o].flat())Jt(s);e&&(_t=o[0].key,Hooks.on("renderSettingsConfig",Si));let a=on();a.api={macros:{permaConditionEffect:mr}};for(let s of Ut){let{init:i,conflicts:c=[],api:l,name:u,socket:f}=s;if(e)for(let d of c){let g=game.modules.get(d);g?.active&&(s.conflicting=!0,gr.add(g.title))}l&&u&&(a.api[u]=l),!s.conflicting&&i&&i(e)}Xt($n)});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Ut)!t&&n&&n(e);if(e)for(let t of gr)M("module-conflict",{name:t},!0)});function Si(e,t){if(!_t)return;let n=k.id;t.find(`.tab[data-tab=${n}] [data-setting-id="${n}.${_t}"]`).before(`<h3>${x("settings.client")}</h3>`)}r(Si,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
